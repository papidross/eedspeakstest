<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EedsClicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; 
            min-height: 10vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background-color: transparent; 
            border-radius: 16px;
            padding: 32px;
            max-width: 1000px; 
            width: 100%;
            position: relative; 
            z-index: 10;
        }
        .glow-text {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3), 0 0 15px rgba(16, 185, 129, 0.8);
        }
        .readable-text-shadow {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8), 0 0 5px rgba(255, 255, 255, 0.2);
        }
        .leaf-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80vmin; 
            height: 80vmin;
            transform: translate(-50%, -50%) rotate(25deg);
            opacity: 0.1; 
            filter: drop-shadow(0 0 15px #059669); 
            z-index: -1; 
            pointer-events: none; 
        }
        .fact-button, .nav-button, .shop-buy-button {
            padding: 12px 24px;
            border-radius: 9999px; 
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 4px;
        }
        .fact-button {
            background-image: linear-gradient(to right, #10b981, #059669); 
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .fact-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.8);
            background-image: linear-gradient(to right, #059669, #10b981);
        }
        .cta-button {
            background-image: linear-gradient(to right, #a855f7, #9333ea); 
            color: white;
            padding: 16px 40px;
            border-radius: 9999px;
            font-size: 1.25rem; 
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 6px 25px rgba(168, 85, 247, 0.6);
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cta-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.9);
        }
        .fact-box, .result-box {
            background-color: transparent; 
            color: #f8fafc; 
            padding: 20px;
            border-radius: 12px;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.125rem;
            font-style: italic;
            transition: all 0.3s ease-in-out;
            border-left: 5px solid #10b981; 
            text-align: center;
        }
        
        /* CHARACTER ANIMATIONS (UPDATED) */
        @keyframes sway {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(0, -5px) rotate(3deg); } 
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        #eeds-character {
            cursor: pointer;
            user-select: none; /* Prevent text selection */
            transition: transform 0.1s, rotate 0.3s ease-out;
        }
        #eeds-character.swaying {
            animation: sway 2.5s infinite ease-in-out;
        }
        #eeds-character.smoking {
            /* Lean forward/right slightly to hit the bong */
            transform: translateX(20px) translateY(10px) scale(1.05); 
            animation: none; 
        }
        
        /* NEW: Refill animation for character */
        #eeds-character.refilling {
            /* Lean more intensely for the refill/scooping motion */
            transform: translateX(30px) translateY(15px) rotate(10deg) scale(1.05); 
            animation: none; 
        }

        @keyframes refill {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #refill-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            animation: refill 0.5s infinite alternate;
            z-index: 50;
            pointer-events: none;
        }
        
        @keyframes puff {
            0% { transform: translate(-50%, 0) scale(0.2); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
        }
        .smoke-puff {
            position: absolute;
            bottom: 232px; 
            left: 50%;
            transform: translate(-50%, 0);
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(5px);
            pointer-events: none;
            animation: puff 1s ease-out forwards;
        }

        @keyframes exhale {
            0% { transform: translate(0, 0) scale(0.1); opacity: 0.5; }
            100% { transform: translate(30px, -80px) scale(1.5); opacity: 0; }
        }
        .smoke-exhale {
            position: absolute;
            bottom: 232px; 
            right: 40%;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            filter: blur(8px);
            pointer-events: none;
            animation: exhale 1.5s ease-out forwards;
            z-index: 20;
        }

        @keyframes fade-up-left {
            0% { opacity: 0; transform: translate(-0px, 10px) scale(0.8); } 
            50% { opacity: 1; transform: translate(-30px, -10px) scale(1); } 
            100% { opacity: 0; transform: translate(-60px, -50px) scale(1.2); } 
        }
        .hit-message {
            position: absolute;
            top: 50%;
            left: 30%; 
            transform: translateY(-50%); 
            font-weight: 800;
            white-space: nowrap;
            pointer-events: none;
            z-index: 50;
            opacity: 0; 
        }

        .weed-game-bg {
            background-color: #1c322b;
            background-image: radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.2) 0%, rgba(30, 41, 59, 0) 70%), 
                              repeating-linear-gradient(135deg, rgba(20, 83, 45, 0.1) 0px, rgba(20, 83, 45, 0.1) 1px, transparent 1px, transparent 5px);
            border: 3px solid #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
        }
        
        /* CRITICAL SMOKE TIME STYLE (EDITED: Gold border, less obstructive) */
        .weed-game-bg.critical-smoke {
            border: 5px solid #facc15; /* Gold/Yellow border */
            box-shadow: 0 0 30px rgba(250, 204, 21, 0.6), 0 0 10px rgba(255, 255, 255, 0.2); /* Gold glow effect */
            background-color: #2b2a1c; /* Gold-tinged dark background */
        }
        
        /* The main CST overlay container is now just a container for the banner, not full-screen */
        #criticalSmokeTimeOverlay {
            pointer-events: none; 
        }
        /* END NEW CRITICAL SMOKE TIME STYLE */

        .shop-item {
            background-color: rgba(30, 41, 59, 0.7); 
            border: 2px solid #a855f7;
        }
        .shop-buy-button {
            background-color: #facc15;
            color: #374151;
            box-shadow: 0 2px 10px rgba(250, 204, 21, 0.6);
        }
        .shop-buy-button:hover:not(:disabled) {
            background-color: #fcd34d;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.9);
        }
        .shop-buy-button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .stat-card {
            background-color: rgba(30, 41, 59, 0.8);
            border: 2px solid #a855f7;
            padding: 16px;
            border-radius: 12px;
        }
        .stat-item {
            padding: 8px 0;
            border-bottom: 1px dashed #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .level-bar-container {
            height: 12px;
            background-color: #4a5568;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 4px;
        }
        .level-bar {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease-out;
        }

        /* Achievement Notification Styles */
        #achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #facc15, #f59e0b);
            color: #374151;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            font-weight: 700;
            z-index: 100;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s, transform 0.5s ease-out;
            max-width: 300px;
        }
        #achievement-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Level Up Notification Styles */
        #level-up-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start off-screen vertically */
            background: linear-gradient(135deg, #a855f7, #9333ea);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(147, 51, 234, 0.6);
            font-weight: 800;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s ease-out;
            max-width: 400px;
            text-align: center;
            border: 3px solid #d8b4fe;
        }
        #level-up-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* Move to screen center */
        }

        .achievement-card {
            background-color: rgba(30, 41, 59, 0.7);
            border: 2px solid #1e293b;
        }
        .achievement-card.unlocked {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        /* Golden Bong Style */
        .golden-bong .bong-glass {
            fill: url(#goldGradient) !important;
            stroke: #ffd700 !important;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }
    </style>
</head>
<body>
    
    <div id="cannabis-bg-overlay" 
         class="fixed inset-0 z-[-2]" 
         style="background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); opacity: 1; background-size: cover; background-attachment: fixed; background-position: center;">
    </div>

    <svg id="cannabis-leaf" class="leaf-bg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M50 0 L40 20 L20 15 L35 40 L20 60 L50 90 L80 60 L65 40 L80 15 L60 20 Z" fill="#10b981"/>
    </svg>

    <div class="container">
        
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-4 tracking-wider text-center glow-text readable-text-shadow">
            EEDSCLICKER <span class="text-emerald-400">(ALPHA 1.0)</span>
        </h1>
        <p class="text-slate-200 mb-8 text-lg text-center readable-text-shadow">
            A game about Eeds smoking, with persistant upgrades.
        </p>

        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="navInfoButton" class="fact-button nav-button">Info & Stats</button>
            <button id="navMinigameButton" class="fact-button nav-button !bg-fuchsia-600 hover:!bg-fuchsia-700 !shadow-fuchsia-500/50">
                The Game
            </button>
            <button id="navShopButton" class="fact-button nav-button !bg-yellow-500 hover:!bg-yellow-600 !shadow-yellow-500/50">
                Shop
            </button>
            <button id="navAchievementsButton" class="fact-button nav-button !bg-blue-500 hover:!bg-blue-600 !shadow-blue-500/50">
                Achievements
            </button>
        </div>

        <div id="achievement-notification" class="hidden">
            <p class="text-xs">🏆 ACHIEVEMENT UNLOCKED!</p>
            <p id="achievement-name" class="text-xl mt-1"></p>
            <p id="achievement-reward" class="text-sm mt-1 text-black/80"></p>
        </div>
        
        <div id="level-up-notification" class="hidden">
            <p class="text-sm">🚀 EEDSCLICKER RANK INCREASED!</p>
            <p id="level-up-name" class="text-2xl mt-1"></p>
        </div>
        <div id="loadingStatus" class="text-center text-white text-lg readable-text-shadow p-4 bg-emerald-600/50 rounded-lg mb-6 hidden">
            </div>

        <div id="infoView" class="hidden">
            <div class="flex flex-wrap justify-center gap-4 mb-10">
                <button class="fact-button" data-fact="mission">How does it work?</button>
                <button class="fact-button" data-fact="founding">Is it fake?</button>
                <button class="fact-button" data-fact="product">Bong or Joint</button>
                <button class="fact-button" data-fact="mascot">Contact us</button>
            </div>

            <div id="factDisplay" class="fact-box readable-text-shadow">
                <p class="text-slate-300">Select a category above to learn more, or click Play Now to start the game!</p>
            </div>
            
            <div class="flex justify-center mt-8">
                <button id="beginTestButton" class="cta-button">PLAY NOW!</button>
            </div>
        </div>

        <div id="testView" class="hidden">
            <p class="text-white text-center readable-text-shadow">Quick test is available by clicking "Begin Test" from the Info tab!</p>
            <p class="text-slate-400 text-center readable-text-shadow mt-2">Use the Mini-Game tab to play and earn coins.</p>
        </div>
        
        <div id="minigameView" class="hidden text-center grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-4">
                <h2 class="text-3xl font-extrabold text-white tracking-wider glow-text readable-text-shadow">
                    EEDSCLICKER (ALPHA 1.0)
                </h2>

                <div id="gameArea" class="weed-game-bg flex justify-center items-end relative h-[448px] w-full overflow-hidden rounded-xl">
                    
                    <div id="counters" class="absolute top-0 left-0 right-0 p-2 flex justify-around text-white font-bold text-lg bg-black/50 rounded-t-xl readable-text-shadow">
                        <div id="hit-counter">Hits: 0</div>
                        <div id="gram-counter">Grams Smoked: 0.0g</div>
                        <div id="coin-counter" class="text-yellow-400">Coins: 0 💰</div> 
                    </div>

                    <div class="absolute top-[55px] left-0 right-0 px-4">
                        <div class="flex justify-between text-xs font-semibold text-white/80 readable-text-shadow">
                            <span id="level-display">LEVEL 1</span>
                            <span id="xp-display">0 / 50 XP</span>
                        </div>
                        <div class="level-bar-container border-2 border-emerald-400">
                            <div id="level-bar" class="level-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div id="refill-loader" class="hidden">REFILLING...</div>
                    
                    <div id="criticalSmokeTimeOverlay" class="absolute top-[110px] left-0 right-0 px-4 hidden z-40">
                        <div class="bg-black/60 p-2 rounded-xl border-2 border-yellow-500 text-center">
                            <p class="text-xl font-extrabold text-yellow-400 glow-text readable-text-shadow">
                                CRITICAL SMOKE TIME!
                            </p>
                            <p id="cst-timer" class="text-sm font-bold text-yellow-300 mt-1 readable-text-shadow">
                                5.0s remaining
                            </p>
                        </div>
                    </div>
                    <svg id="cosmic-bong" class="w-24 h-48 absolute bottom-[40px] right-1/2 translate-x-1/2 mr-4" viewBox="0 0 100 250" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <radialGradient id="glassGradient" cx="50%" cy="50%" r="50%" fx="60%" fy="60%">
                                <stop offset="0%" style="stop-color:rgb(255,255,255);stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:rgb(192,236,255);stop-opacity:0.3" />
                            </radialGradient>
                            <linearGradient id="waterGradient" x1="0" y1="200" x2="0" y2="250" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#3b82f6"/>
                                <stop offset="1" stop-color="#0ea5e9" stop-opacity="0.5"/>
                            </linearGradient>
                            <linearGradient id="goldGradient" x1="0" y1="0" x2="0" y2="250" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" style="stop-color:#ffe495;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#ffd700;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#c8b04a;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M10 250 Q 5 210, 25 200 H 75 Q 95 210, 90 250 Z" class="bong-glass" fill="url(#glassGradient)" stroke="#93c5fd" stroke-width="2" stroke-opacity="0.6"/>
                        <path d="M15 250 Q 10 220, 30 210 H 70 Q 90 220, 85 250 Z" fill="url(#waterGradient)"/>
                        
                        <path id="water-dirt-overlay" d="M15 250 Q 10 220, 30 210 H 70 Q 90 220, 85 250 Z" fill="#6d4128" style="opacity: 0; mix-blend-mode: multiply; transition: opacity 0.5s;"/>

                        <rect id="bong-main-tube" x="35" y="20" width="30" height="190" class="bong-glass" fill="url(#glassGradient)" stroke="#93c5fd" stroke-width="2" rx="5"/>
                        <rect id="dirt-overlay" x="35" y="20" width="30" height="190" fill="#6d4128" rx="5" style="mix-blend-mode: multiply; opacity: 0; transition: opacity 0.5s;"/>

                        <rect x="30" y="10" width="40" height="15" fill="#9333ea" stroke="#d8b4fe" stroke-width="2" rx="7"/>
                        <rect x="65" y="195" width="5" height="15" fill="#4b5563" transform="rotate(15 65 195)"/> 
                        
                        <circle cx="78" cy="180" r="10" fill="#facc15" stroke="#f59e0b" stroke-width="2"/>
                        <circle id="weed-stash" cx="78" cy="180" r="8" fill="#10b981" style="transition: all 0.1s ease-out;"/>
                        <circle id="burning-ember" cx="78" cy="180" r="10" fill="#ff4400" opacity="0" style="transition: opacity 0.1s; filter: blur(2px); pointer-events: none;"/>
                        
                        <circle cx="50" cy="225" r="5" fill="#e0f2fe" fill-opacity="0.8"/>
                        <circle cx="40" cy="235" r="3" fill="#e0f2fe" fill-opacity="0.8"/>
                    </svg>

                    <svg id="eeds-character" class="w-48 h-80 absolute bottom-[-48px] right-1/2 translate-x-1/2 ml-4" viewBox="0 0 150 200" fill="none" xmlns="http://www.w3.org/2000/svg" style="transition: transform 0.2s, rotate 0.2s;">
                        <circle cx="75" cy="20" r="15" fill="#fef08a" stroke="#f59e0b" stroke-width="2"/>
                        <circle cx="70" cy="18" r="1.5" fill="#333"/>
                        <circle cx="80" cy="18" r="1.5" fill="#333"/>
                        <path id="eeds-mouth" d="M80 25 Q 85 28, 90 25" stroke="#a855f7" stroke-width="1.5" fill="none"/>
                        <path d="M68 8 Q 75 -5, 82 8 C 80 15, 75 18, 70 15 Z" fill="#444" stroke="#333" stroke-width="1"/>
                        <rect x="65" y="35" width="20" height="85" fill="#10b981" rx="5"/>
                        <path d="M75 50 L95 70 L100 100" stroke="#fef08a" stroke-width="5" stroke-linecap="round" fill="none"/>
                        <line x1="75" y1="120" x2="55" y2="150" stroke="#fef08a" stroke-width="5" stroke-linecap="round"/>
                        <line x1="75" y1="120" x2="95" y2="150" stroke="#fef08a" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                    
                    <p id="click-instruction" class="absolute bottom-[10px] left-1/2 transform -translate-x-1/2 text-lg font-bold text-lime-300 readable-text-shadow z-30 tracking-wider uppercase">
                        CLICK TO TAKE A HIT!
                    </p>

                </div>

                <div class="flex justify-center mt-4 space-x-4">
                    <div class="p-3 bg-red-800/50 text-white rounded-lg font-semibold readable-text-shadow flex items-center">
                        <span class="text-xl mr-2">💧</span> Water Dirt: <span id="stat-water-dirt" class="ml-1">0 / 50</span>
                    </div>
                    <button id="changeWaterButton" class="cta-button !text-base !py-3 !px-6 !bg-blue-600 hover:!bg-blue-700 !shadow-blue-500/50" disabled>
                        Change Water (200💰)
                    </button>
                </div>
                
                <div id="win-bar" class="hidden mt-4 p-4 rounded-lg text-center font-extrabold text-2xl readable-text-shadow" 
                     style="background: linear-gradient(90deg, #facc15, #f59e0b, #facc15); box-shadow: 0 0 20px #facc15;">
                    </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <h3 class="text-2xl font-bold text-white text-center readable-text-shadow">
                    SMOKING STATS
                </h3>
                <div class="stat-card">
                    <p class="text-lg font-bold text-yellow-400 text-center mb-2">
                        LEVEL <span id="current-level-stat">1</span>
                    </p>
                    <div class="stat-item !border-b-2 !border-fuchsia-500 mb-2">
                        <span class="text-slate-300 font-extrabold text-fuchsia-400">CURRENT RANK</span>
                        <span id="stat-rank" class="font-extrabold text-white">Bud Novice</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Total Hits Taken</span>
                        <span id="stat-hits-taken" class="font-extrabold text-emerald-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Total Gold Earned</span>
                        <span id="stat-gold-earned" class="font-extrabold text-yellow-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Biggest Hit (g)</span>
                        <span id="stat-biggest-hit" class="font-extrabold text-red-400">0.0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">XP Until Next Level</span>
                        <span id="stat-xp-to-next" class="font-extrabold text-fuchsia-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Bong Resin (Penalty)</span>
                        <span id="stat-dirtiness" class="font-extrabold text-red-400">0%</span>
                    </div>
                </div>
            </div>
            </div>
        <div id="shopView" class="hidden">
            <h2 class="text-3xl font-extrabold text-white mb-4 tracking-wider glow-text readable-text-shadow text-center">
                EEDSCLICKER UPGRADES
            </h2>
            
            <div class="text-center mb-8 bg-black/30 p-4 rounded-xl border-b-4 border-yellow-500 shadow-lg">
                <p class="text-4xl font-extrabold text-yellow-400 readable-text-shadow">
                    <span id="shop-coin-counter">0</span> 💰
                </p>
                <p class="text-lg text-slate-300 font-semibold">Your Current Balance</p>
            </div>
            <p class="text-slate-300 mb-8 text-center readable-text-shadow">
                Spend your gold coins to enhance Eeds' smoking power and efficiency!
            </p>
            <div id="shopItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>

        <div id="achievementsView" class="hidden">
             <h2 class="text-3xl font-extrabold text-white mb-6 tracking-wider glow-text readable-text-shadow text-center">
                Smoking Milestones 🏆
            </h2>
            <div id="achievementsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
        </div>
        
    </div>

    <script>
        
        // =========================================================================
        // !!! FIREBASE CONFIGURATION (REMOVED TO FIX API KEY ERROR) !!!
        // Game now relies solely on Local Storage.
        // =========================================================================
        
        // --- GLOBAL CONSTANTS (UPDATED BASE_MIN_HIT and BASE_MAX_HIT) ---
        const FACTS = {
            mission: "Simply click on the Begin Test button, and take a test to find out the true amount of Cannabis Eedspeaks smoked in a week.",
            founding: "Everything shown on the website is correct information obtained after years of years of regular investigation.",
            product: "Eedspeaks usually only smokes from a Bong, but he isn't against a well-rolled L joint. <br><br><strong>Fun Fact:</strong> Eeds can smoke an L joint in 5 minutes.",
            mascot: "For all inquiries, contact Eeds directly via his galactic communicator at **eedspeaks@cosmiccloud.net** or send a transmission through the nebula."
        };
        
        const WIN_GRAMS = 20.0;
        const BASE_GOLD_PER_GRAM = 50; // New: Halved income to slow progression (0.01g hit gives 0.5 gold/1g gold).
        
        const BASE_BONUS_DROP_CHANCE = 0.2; 
        const BASE_BONUS_DROP_AMOUNT = 10; 
        
        const BASE_DOUBLE_HIT_CHANCE = 0.1;
        
        // --- EXISTING: SINGLE CRITICAL HIT CONSTANTS (0.01%) ---
        const CRITICAL_HIT_CHANCE = 0.01; // 1% chance
        const CRITICAL_HIT_MULTIPLIER = 2.5; // 2.5x multiplier for grams and gold
        // -----------------------------------
        // --- NEW: CRITICAL SMOKE TIME CONSTANTS (5% Event) ---
        const CRITICAL_SMOKE_TIME_CHANCE = 0.05; // 5% chance
        const CRITICAL_SMOKE_TIME_DURATION = 5000; // 5 seconds
        const CRITICAL_SMOKE_TIME_GRAM_MULTIPLIER = 2.0;
        const CRITICAL_SMOKE_TIME_GOLD_MULTIPLIER = 3.0;
        const CST_SMOKE_DELAY_REDUCTION = 500; // NEW: Reduce delay by 500ms
        const CST_MIN_SMOKE_DELAY = 100; // NEW: Minimum delay during CST
        // ------------------------------------------
        // --- UPDATED MIN/MAX HIT VALUES ---
        const BASE_MIN_HIT = 0.01; // Changed from 0.1
        const BASE_MAX_HIT = 0.2; // Changed from 0.5
        // ----------------------------------
        const BASE_SMOKE_DELAY = 1000;
        const BASE_XP = 50;
        const XP_RATE = 1.6;
        const MILESTONE_REWARD = 150;
        const MAX_DIRTINESS = 100;
        const DIRTINESS_PENALTY_PER_UNIT = 0.005;
        const BONG_MASTER_COST = 200; // New: Doubled cost to slow progression
        const MAX_WATER_DIRTINESS = 100;
        const WATER_CHANGE_COST = 200; // New: Doubled cost to slow progression
        const GOLDEN_BONG_COST = 5000; // New: Doubled cost to slow progression
        const GOLDEN_BONG_MULTIPLIER = 3;
        const MAX_HITS_PER_BOWL = 10;
        const BASE_REFILL_DURATION = 2000; // 2 seconds
        
        // --- SHOP ITEM CONFIGURATION (COSTS DOUBLED TO SLOW PROGRESSION) ---
        const SHOP_ITEMS_CONFIG = [
            { id: 'gramBoost', name: 'Grinder Upgrade', desc: 'Increases Max Hit by +0.1g', baseCost: 100, gramBoost: 0.1, maxPurchases: 5, icon: '🔥' },
            { id: 'speedBoost', name: 'Fast Lighter', desc: 'Reduces Hit Delay by -10%', baseCost: 200, speedBoost: 0.1, maxPurchases: 5, icon: '⚡' },
            { id: 'coinChance', name: 'Hydroponic Setup', desc: 'Increases Bonus Gold Chance by +5%', baseCost: 300, coinChanceBoost: 0.05, maxPurchases: 4, icon: '🌱' },
            { id: 'coinAmount', name: 'Munchies Fund', desc: 'Increases Bonus Gold Amount by +10', baseCost: 400, coinAmountBoost: 10, maxPurchases: 5, icon: '🍔' },
            { id: 'doubleChance', name: 'Concentrate Cart', desc: 'Increases Double Hit Chance by +2%', baseCost: 600, doubleChanceBoost: 0.02, maxPurchases: 5, icon: '🍯' },
            { id: 'reloadSpeed', name: 'Faster Reload', desc: 'Increases bowl reload speed by 10%', baseCost: 300, reloadSpeedBoost: 0.1, maxPurchases: 4, icon: '💨' },
            { id: 'bong_master', name: 'Bong Master', desc: 'Instantly cleans the bong glass/resin.', baseCost: BONG_MASTER_COST, maxPurchases: 99, icon: '🧼' },
            { id: 'golden_bong', name: 'Golden Bong', desc: `Triples all gold income!`, baseCost: GOLDEN_BONG_COST, maxPurchases: 1, icon: '🌟' },
        ];

        // --- ACHIEVEMENTS CONFIGURATION ---
        const ACHIEVEMENTS_CONFIG = [
            { id: 'first_hit', name: 'First Toke', desc: 'Take your very first hit.', reward: 10, check: (state) => state.hits >= 1 },
            { id: 'baby_lungs', name: 'Baby Lungs', desc: 'Smoke 1.0 total grams.', reward: 25, check: (state) => state.gramsSmoked >= 1.0 },
            { id: 'quarter_ounce', name: 'Quarter Ounce Quest', desc: 'Smoke 7.0 total grams.', reward: 50, check: (state) => state.gramsSmoked >= 7.0 },
            { id: 'half_ounce', name: 'Half Ounce Haze', desc: 'Smoke 14.0 total grams.', reward: 100, check: (state) => state.gramsSmoked >= 14.0 },
            { id: 'big_rip', name: 'Biggest Rip Ever', desc: 'Achieve a single hit of 1.0g or more.', reward: 50, check: (state) => state.biggestHit >= 1.0 },
            { id: 'high_roller', name: 'High Roller', desc: 'Earn 500 total gold coins.', reward: 75, check: (state) => state.goldEarnedTotal >= 500 },
            { id: 'max_level_gram', name: 'Maxed Grinder', desc: 'Max out the Grinder Upgrade (Level 5).', reward: 150, check: (state) => state.gramBoostLevel >= 5 },
            { id: 'level_5', name: 'Cosmic Smoker', desc: 'Reach Level 5.', reward: 200, check: (state) => state.currentLevel >= 5 },
            { id: 'hyi_vittu', name: 'Hyi vittu', desc: 'Reach 100% Bong Dirtiness Level.', reward: 100, check: (state) => state.bongDirtiness >= MAX_DIRTINESS },
        ];
        
        // --- CONSTANTS for Ranks ---
        const RANKS_CONFIG = [
            { grams: 1000, name: 'Eedspeaks' },
            { grams: 500, name: 'Mestari Smoukkaaja' },
            { grams: 100, name: 'One-Hit Smoukkaaja' },
            { grams: 28, name: 'Priiman Spottaaja' },
            { grams: 10, name: 'Bongin Imppaaja' },
            { grams: 5, name: 'Karsta Looter' },
            { grams: 1, name: 'Jointin Rollaaja' },
            { grams: 0, name: 'Prässimies' },
        ];

        // --- NEW FUNCTION: Determine Current Rank ---
        function getCurrentRank() {
            for (const rank of RANKS_CONFIG) {
                if (gameState.gramsSmoked >= rank.grams) {
                    return rank.name;
                }
            }
            return 'Unranked'; // Fallback
        }

        // --- DOM ELEMENTS (UPDATED FOR CRITICAL SMOKE TIME) ---
        const infoView = document.getElementById('infoView');
        const testView = document.getElementById('testView');
        const minigameView = document.getElementById('minigameView');
        const shopView = document.getElementById('shopView');
        const achievementsView = document.getElementById('achievementsView');
        const factDisplay = document.getElementById('factDisplay');
        const eedsCharacter = document.getElementById('eeds-character');
        const hitCounterDisplay = document.getElementById('hit-counter');
        const gramCounterDisplay = document.getElementById('gram-counter');
        const coinCounterDisplay = document.getElementById('coin-counter');
        const shopCoinCounter = document.getElementById('shop-coin-counter');
        const winBar = document.getElementById('win-bar');
        const loadingStatus = document.getElementById('loadingStatus');
        const shopItemsContainer = document.getElementById('shopItemsContainer');
        const achievementsContainer = document.getElementById('achievementsContainer');
        const gameArea = document.getElementById('gameArea');
        
        // Bong elements
        const waterDirtOverlay = document.getElementById('water-dirt-overlay');
        const dirtOverlay = document.getElementById('dirt-overlay');
        const statWaterDirt = document.getElementById('stat-water-dirt');
        const changeWaterButton = document.getElementById('changeWaterButton');
        const bongWaterText = document.querySelector('#changeWaterButton').textContent;
        
        // Bong Visual Elements
        const bongSvg = document.getElementById('cosmic-bong');
        const bongGlassParts = document.querySelectorAll('.bong-glass');
        
        // Hit elements
        const burningEmber = document.getElementById('burning-ember');
        const weedStash = document.getElementById('weed-stash');
        const clickInstruction = document.getElementById('click-instruction');
        const refillLoader = document.getElementById('refill-loader');
        
        // Stat elements
        const statHitsTaken = document.getElementById('stat-hits-taken');
        const statGoldEarned = document.getElementById('stat-gold-earned');
        const statBiggestHit = document.getElementById('stat-biggest-hit');
        const statDirtiness = document.getElementById('stat-dirtiness');
        const statRank = document.getElementById('stat-rank');
        const currentLevelStat = document.getElementById('current-level-stat');
        const statXpToNext = document.getElementById('stat-xp-to-next');
        
        // Level elements
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const levelBar = document.getElementById('level-bar');
        
        // Achievement Notif
        const achievementNotification = document.getElementById('achievement-notification');
        const achievementNameDisplay = document.getElementById('achievement-name');
        const achievementRewardDisplay = document.getElementById('achievement-reward');
        
        // Level Up Notif
        const levelUpNotification = document.getElementById('level-up-notification');
        const levelUpNameDisplay = document.getElementById('level-up-name');
        
        // NEW CST DOM ELEMENTS
        const criticalSmokeTimeOverlay = document.getElementById('criticalSmokeTimeOverlay');
        const cstTimerDisplay = document.getElementById('cst-timer');
        
        // --- GAME STATE ---
        let gameState = {
            // Core stats
            gold: 0,
            goldEarnedTotal: 0,
            gramsSmoked: 0.0,
            hits: 0,
            biggestHit: 0.0,
            
            // Progression
            currentLevel: 1,
            currentXP: 0,
            xpToNextLevel: BASE_XP,
            
            // Mechanics
            bongDirtiness: 0, // 0 to MAX_DIRTINESS (100)
            bongWaterDirtiness: 0, // 0 to MAX_WATER_DIRTINESS (100)
            hitsInCurrentBowl: 0,
            
            // Upgrade Levels (from SHOP_ITEMS_CONFIG)
            gramBoostLevel: 0, // Grinder Upgrade (baseCost: 100, +0.1g)
            speedBoostLevel: 0, // Fast Lighter (baseCost: 200, -10% delay)
            coinChanceLevel: 0, // Hydroponic Setup (baseCost: 300, +5% bonus chance)
            coinAmountLevel: 0, // Munchies Fund (baseCost: 400, +10 bonus amount)
            doubleChanceLevel: 0, // Concentrate Cart (baseCost: 600, +2% double chance)
            reloadSpeedLevel: 0, // Faster Reload (baseCost: 300, -10% reload duration)

            // Permanent Upgrades
            hasGoldenBong: false,

            // Achievements
            achievements: ACHIEVEMENTS_CONFIG.reduce((acc, achievement) => {
                acc[achievement.id] = { unlocked: false, rewarded: false };
                return acc;
            }, {}),
            
            // CST State
            isCriticalSmokeTime: false,
            cstEndTime: 0,
            cstInterval: null,
            
            // Game flags
            isSmoking: false,
            isRefilling: false,
            lastSaveTime: Date.now()
        };

        // --- TONE.JS SOUND SETUP (EDITED FOR REALISTIC BONG HIT SOUND) ---
        // Need to initialize Tone.js, e.g. on first user interaction
        let initialized = false;
        
        // A simple synth for the coin sound
        const coinSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'square' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
        }).toDestination();
        
        // Noise synth for the inhale (Pink Noise, long envelope)
        const inhaleNoise = new Tone.NoiseSynth({
            noise: { type: 'pink' }, 
            envelope: { attack: 0.05, decay: 0.7, sustain: 0.1, release: 0.1 } // Slow attack, long decay for draw
        }).toDestination();
        
        // Synth for the exhale/release sound (Square wave, quick envelope)
        const exhaleSynth = new Tone.Synth({
            oscillator: { type: 'square' }, 
            envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } // Short, percussive envelope
        }).toDestination();

        // Function to play the coin sound when gold is gained (less subtle sound requested)
        function playCoinSound() {
            if (initialized) {
                // Changed from high, quick ['C5', 'E5', 'G5'], '16n' to lower, more pronounced ['G4', 'C5', 'E5'], '8n'
                coinSynth.triggerAttackRelease(['G4', 'C5', 'E5'], '8n', Tone.now()); 
            }
        }
        
        // Function to play the hit sound (Mimicking a subtle, realistic bong draw and exhale)
        function playHitSound() {
            if (initialized) {
                const now = Tone.now();
                
                // 1. The Inhale (Draw): Long pink noise with low volume for subtlety
                inhaleNoise.volume.value = -10; // **FIXED ERROR: Used .value instead of .setValue**
                inhaleNoise.triggerAttackRelease('0.8', now); 

                // 2. The Exhale/Release: Low, punchy tone for the release
                exhaleSynth.triggerAttackRelease('G2', '0.2', now + 0.6, 0.5); // Delayed for the release, volume 0.5
            }
        }
        
        // Function to play a negative/buzz sound for failed purchase or max dirtiness
        function playNegativeSound() {
            if (initialized) {
                // Quick, dissonant buzz
                coinSynth.triggerAttackRelease(['C3', 'B2'], '16n', Tone.now(), 0.8);
            }
        }
        
        // Function to play a level up/major milestone sound
        function playLevelUpSound() {
            if (initialized) {
                const now = Tone.now();
                // Upward sweeping arpeggio
                coinSynth.triggerAttackRelease(['C5', 'E5', 'G5', 'C6'], '4n', now);
                coinSynth.triggerAttackRelease(['G5', 'C6'], '8n', now + 0.2, 0.5);
            }
        }

        // --- GAME LOGIC FUNCTIONS ---
        
        // Function to calculate the cost of purchasing an item
        function calculateCost(baseCost, level) {
            // Exponential scaling: cost = baseCost * (1.5 ^ level)
            return Math.ceil(baseCost * Math.pow(1.5, level));
        }

        // Function to calculate the current maximum hit size based on upgrades
        function getMaxHit() {
            const baseMax = BASE_MAX_HIT;
            const gramBoost = gameState.gramBoostLevel * 0.1; 
            return baseMax + gramBoost;
        }

        // Function to calculate the current smoke delay based on upgrades
        function getSmokeDelay() {
            const baseDelay = BASE_SMOKE_DELAY;
            const speedReduction = gameState.speedBoostLevel * 0.1; // 10% reduction per level
            
            // Calculate delay: baseDelay * (1 - totalReduction)
            let currentDelay = baseDelay * (1 - speedReduction);
            
            // Apply CST reduction if active
            if (gameState.isCriticalSmokeTime) {
                currentDelay -= CST_SMOKE_DELAY_REDUCTION;
            }
            
            // Ensure minimum delay is respected
            return Math.max(currentDelay, CST_MIN_SMOKE_DELAY);
        }
        
        // Function to calculate the bowl refill duration
        function getRefillDuration() {
            const baseDuration = BASE_REFILL_DURATION;
            const reloadReduction = gameState.reloadSpeedLevel * 0.1; // 10% reduction per level
            
            // Duration: baseDuration * (1 - totalReduction)
            // Minimum duration 500ms
            return Math.max(baseDuration * (1 - reloadReduction), 500); 
        }

        // Function to calculate the current dirtiness penalty multiplier (1.0 = no penalty, 0.5 = half output)
        function getDirtinessPenalty() {
            const resinPenalty = gameState.bongDirtiness * DIRTINESS_PENALTY_PER_UNIT;
            const waterPenalty = gameState.bongWaterDirtiness * DIRTINESS_PENALTY_PER_UNIT;
            
            const totalPenalty = Math.min(resinPenalty + waterPenalty, 0.95); // Max 95% penalty
            
            return 1.0 - totalPenalty;
        }

        // Main function to update UI elements from gameState
        function updateUI() {
            // Counters
            hitCounterDisplay.textContent = `Hits: ${gameState.hits}`;
            gramCounterDisplay.textContent = `Grams Smoked: ${gameState.gramsSmoked.toFixed(2)}g`;
            coinCounterDisplay.textContent = `Coins: ${formatNumber(gameState.gold)} 💰`;
            shopCoinCounter.textContent = formatNumber(gameState.gold);
            
            // Stats
            statHitsTaken.textContent = formatNumber(gameState.hits);
            statGoldEarned.textContent = formatNumber(gameState.goldEarnedTotal);
            statBiggestHit.textContent = gameState.biggestHit.toFixed(2);
            statDirtiness.textContent = `${(getDirtinessPenalty() * 100).toFixed(0)}% (Efficiency)`;
            statRank.textContent = getCurrentRank();
            
            // Bong Dirtiness
            statWaterDirt.textContent = `${gameState.bongWaterDirtiness} / ${MAX_WATER_DIRTINESS}`;
            const dirtOpacity = (gameState.bongWaterDirtiness / MAX_WATER_DIRTINESS) * 0.7; // Max 70% opacity
            waterDirtOverlay.style.opacity = dirtOpacity;
            dirtOverlay.style.opacity = (gameState.bongDirtiness / MAX_DIRTINESS) * 0.7;
            
            // Water Change Button
            changeWaterButton.textContent = bongWaterText.replace('(200💰)', `(${WATER_CHANGE_COST}💰)`);
            changeWaterButton.disabled = gameState.gold < WATER_CHANGE_COST || gameState.bongWaterDirtiness === 0 || gameState.isSmoking || gameState.isRefilling;
            
            // Leveling
            levelDisplay.textContent = `LEVEL ${gameState.currentLevel}`;
            currentLevelStat.textContent = gameState.currentLevel;
            xpDisplay.textContent = `${gameState.currentXP} / ${gameState.xpToNextLevel} XP`;
            statXpToNext.textContent = formatNumber(gameState.xpToNextLevel - gameState.currentXP);
            levelBar.style.width = `${(gameState.currentXP / gameState.xpToNextLevel) * 100}%`;
            
            // Golden Bong Visual
            if (gameState.hasGoldenBong) {
                bongSvg.classList.add('golden-bong');
            } else {
                bongSvg.classList.remove('golden-bong');
            }
            
            // CST Visuals
            if (gameState.isCriticalSmokeTime) {
                gameArea.classList.add('critical-smoke');
                criticalSmokeTimeOverlay.classList.remove('hidden');
            } else {
                gameArea.classList.remove('critical-smoke');
                criticalSmokeTimeOverlay.classList.add('hidden');
            }
            
            // Win check
            if (gameState.gramsSmoked >= WIN_GRAMS && winBar.classList.contains('hidden')) {
                winBar.textContent = `🎉 YOU SMOKED ${WIN_GRAMS} GRAMS! EEDS IS PROUD! 🎉`;
                winBar.classList.remove('hidden');
                eedsCharacter.removeEventListener('click', triggerBongHit);
                clickInstruction.textContent = 'GAME OVER - WELL DONE!';
            }

            // Update Shop Item costs and state
            renderShopItems();
        }
        
        function formatNumber(num) {
            if (num >= 1000) {
                return num.toLocaleString();
            }
            return num;
        }

        // Function to handle XP gain and leveling
        function gainXP(amount) {
            gameState.currentXP += amount;
            
            while (gameState.currentXP >= gameState.xpToNextLevel) {
                // Level Up!
                gameState.currentXP -= gameState.xpToNextLevel;
                gameState.currentLevel++;
                
                // Calculate new XP target: oldTarget * XP_RATE
                gameState.xpToNextLevel = Math.ceil(gameState.xpToNextLevel * XP_RATE);
                
                // Show notification and play sound
                showLevelUpNotification(gameState.currentLevel);
                playLevelUpSound();
                
                // Check if any achievement requires the new level
                checkAchievements();
            }
        }
        
        // Function to handle the actual hit logic
        function bongHit() {
            gameState.isSmoking = true;
            eedsCharacter.classList.remove('swaying');
            eedsCharacter.classList.add('smoking');
            clickInstruction.classList.add('hidden');
            
            // 1. Play Visual/Sound Effects
            playHitSound();
            burningEmber.style.opacity = 1;
            weedStash.style.r = 4; // Shrink the stash visually
            
            // 2. Determine Hit Size (Min/Max based on level, multiplied by penalty)
            const minHit = BASE_MIN_HIT;
            const maxHit = getMaxHit();
            
            let hitGrams = minHit + (Math.random() * (maxHit - minHit));
            let goldValue = Math.ceil(hitGrams * BASE_GOLD_PER_GRAM);
            
            // 3. Apply Multipliers (Dirtiness, CST, Critical Hit)
            let multiplier = getDirtinessPenalty();
            let isCritical = false;
            let isDouble = false;
            
            // Check for single Critical Hit
            if (Math.random() < CRITICAL_HIT_CHANCE) {
                multiplier *= CRITICAL_HIT_MULTIPLIER;
                isCritical = true;
            }
            
            // Check for Double Hit (Upgrade)
            if (Math.random() < BASE_DOUBLE_HIT_CHANCE + (gameState.doubleChanceLevel * 0.02)) {
                multiplier *= 2;
                isDouble = true;
            }

            // Apply CST multipliers last
            if (gameState.isCriticalSmokeTime) {
                multiplier *= CRITICAL_SMOKE_TIME_GRAM_MULTIPLIER;
                goldValue *= CRITICAL_SMOKE_TIME_GOLD_MULTIPLIER;
            }
            
            hitGrams *= multiplier;
            goldValue *= multiplier;
            
            // 4. Apply Bonus Gold Drop (Upgrade)
            let bonusGold = 0;
            const bonusChance = BASE_BONUS_DROP_CHANCE + (gameState.coinChanceLevel * 0.05);
            if (Math.random() < bonusChance) {
                bonusGold = BASE_BONUS_DROP_AMOUNT + (gameState.coinAmountLevel * 10);
            }

            // 5. Apply Golden Bong Multiplier (Permanent)
            if (gameState.hasGoldenBong) {
                goldValue *= GOLDEN_BONG_MULTIPLIER;
                bonusGold *= GOLDEN_BONG_MULTIPLIER;
            }
            
            // 6. Update Game State
            hitGrams = parseFloat(hitGrams.toFixed(3)); // Clamp to 3 decimal places
            goldValue = Math.ceil(goldValue);
            bonusGold = Math.ceil(bonusGold);

            gameState.gramsSmoked += hitGrams;
            gameState.hits++;
            gameState.gold += goldValue + bonusGold;
            gameState.goldEarnedTotal += goldValue + bonusGold;
            gameState.hitsInCurrentBowl++;
            
            // Bong Dirtiness increases per hit (min 1, max 100)
            const dirtIncrement = Math.ceil(hitGrams * 20); // 1g adds 20 dirt
            gameState.bongDirtiness = Math.min(gameState.bongDirtiness + dirtIncrement, MAX_DIRTINESS);
            gameState.bongWaterDirtiness = Math.min(gameState.bongWaterDirtiness + dirtIncrement, MAX_WATER_DIRTINESS);
            
            // XP is half the base gold value
            gainXP(Math.ceil(goldValue / 2));
            
            // 7. Check for Biggest Hit update
            if (hitGrams > gameState.biggestHit) {
                gameState.biggestHit = hitGrams;
            }
            
            // 8. Show Hit Message
            let message = `+${hitGrams.toFixed(2)}g`;
            if (isCritical) {
                message = `CRITICAL HIT! +${hitGrams.toFixed(2)}g`;
            } else if (isDouble) {
                message = `DOUBLE HIT! +${hitGrams.toFixed(2)}g`;
            }
            
            message += ` (${goldValue}💰)`;
            if (bonusGold > 0) {
                message += ` +BONUS ${bonusGold}💰!`;
                playCoinSound(); // Play bonus sound (coin)
            }
            
            // 9. Spawn smoke and hit message
            spawnSmokeExhale();
            spawnHitMessage(message, isCritical || gameState.isCriticalSmokeTime);
            
            // 10. Reset Hit Visuals
            setTimeout(() => {
                burningEmber.style.opacity = 0;
                weedStash.style.r = 8; // Restore stash size
                eedsCharacter.classList.remove('smoking');
                
                // Check if bowl is done or if a new CST should start
                if (gameState.hitsInCurrentBowl >= MAX_HITS_PER_BOWL) {
                    startRefill();
                } else {
                    gameState.isSmoking = false;
                    eedsCharacter.classList.add('swaying');
                    clickInstruction.classList.remove('hidden');
                    
                    // Check for CST Trigger
                    if (!gameState.isCriticalSmokeTime && Math.random() < CRITICAL_SMOKE_TIME_CHANCE) {
                        startCriticalSmokeTime();
                    }
                }
                
                updateUI();
                checkAchievements();
                saveGame();
            }, getSmokeDelay());
        }

        // Function to handle the bong click (user action)
        function triggerBongHit() {
            if (gameState.isSmoking || gameState.isRefilling || gameState.gramsSmoked >= WIN_GRAMS) return;
            
            // Initialize Tone.js on first click
            if (!initialized) {
                Tone.start();
                initialized = true;
            }
            
            bongHit();
        }
        
        // Function to start the bowl refill process
        function startRefill() {
            gameState.isRefilling = true;
            gameState.isSmoking = true; // Block interaction
            eedsCharacter.classList.remove('swaying');
            eedsCharacter.classList.remove('smoking');
            eedsCharacter.classList.add('refilling');
            clickInstruction.classList.add('hidden');
            refillLoader.classList.remove('hidden');
            
            // Reset bowl
            gameState.hitsInCurrentBowl = 0;
            gameState.bongDirtiness = Math.max(0, gameState.bongDirtiness - 5); // Small self-clean
            
            setTimeout(() => {
                gameState.isRefilling = false;
                gameState.isSmoking = false; // Allow interaction
                eedsCharacter.classList.remove('refilling');
                eedsCharacter.classList.add('swaying');
                clickInstruction.classList.remove('hidden');
                refillLoader.classList.add('hidden');
                
                updateUI();
                saveGame();
            }, getRefillDuration());
        }

        // Function to clean the bong water
        function changeBongWater() {
            if (gameState.gold >= WATER_CHANGE_COST) {
                gameState.gold -= WATER_CHANGE_COST;
                gameState.bongWaterDirtiness = 0;
                playCoinSound();
                updateUI();
                saveGame();
            } else {
                playNegativeSound();
            }
        }
        
        // Function to start the Critical Smoke Time event
        function startCriticalSmokeTime() {
            if (gameState.isCriticalSmokeTime) return;
            
            gameState.isCriticalSmokeTime = true;
            gameState.cstEndTime = Date.now() + CRITICAL_SMOKE_TIME_DURATION;
            
            // Update UI immediately to show the banner
            updateUI(); 
            
            // Set up a timer to update the countdown
            if (gameState.cstInterval) clearInterval(gameState.cstInterval);
            
            gameState.cstInterval = setInterval(() => {
                const remaining = Math.max(0, gameState.cstEndTime - Date.now());
                cstTimerDisplay.textContent = `${(remaining / 1000).toFixed(1)}s remaining`;
                
                if (remaining === 0) {
                    endCriticalSmokeTime();
                }
            }, 100); 
        }

        // Function to end the Critical Smoke Time event
        function endCriticalSmokeTime() {
            if (!gameState.isCriticalSmokeTime) return;
            
            gameState.isCriticalSmokeTime = false;
            clearInterval(gameState.cstInterval);
            gameState.cstInterval = null;
            
            // Update UI to hide the banner
            updateUI(); 
        }

        // --- SHOP & UPGRADES ---
        
        function getLevel(itemId) {
            const config = SHOP_ITEMS_CONFIG.find(item => item.id === itemId);
            if (!config) return 0;
            
            if (itemId === 'bong_master' || itemId === 'golden_bong') {
                return 0; 
            }
            
            // Convert to camelCase property name for state lookup
            const levelProp = config.id + 'Level';
            return gameState[levelProp] || 0;
        }

        function renderShopItems() {
            shopItemsContainer.innerHTML = '';
            
            SHOP_ITEMS_CONFIG.forEach(item => {
                const currentLevel = getLevel(item.id);
                const isMaxed = currentLevel >= item.maxPurchases;
                const cost = calculateCost(item.baseCost, currentLevel);
                const canAfford = gameState.gold >= cost;
                
                if (item.id === 'golden_bong' && gameState.hasGoldenBong) return; // Hide if already bought
                if (isMaxed && item.id !== 'bong_master') return; // Hide maxed permanent upgrades (but not consumable)

                const shopItemDiv = document.createElement('div');
                shopItemDiv.className = 'shop-item p-4 rounded-xl shadow-xl flex flex-col justify-between h-full';
                
                // Title and Icon
                let titleHtml = `<div class="flex items-center space-x-2 mb-2">
                                    <span class="text-3xl">${item.icon}</span>
                                    <h4 class="text-xl font-bold text-white">${item.name}</h4>
                                </div>`;
                
                // Level / Status
                let statusHtml = '';
                if (item.id === 'golden_bong') {
                    statusHtml = `<p class="text-sm font-bold text-yellow-400">STATUS: UNIQUE UPGRADE</p>`;
                } else if (item.id === 'bong_master') {
                    statusHtml = `<p class="text-sm font-bold text-emerald-400">CONSUMABLE UPGRADE</p>`;
                } else {
                    statusHtml = `<p class="text-sm font-bold text-slate-300">LEVEL ${currentLevel} / ${item.maxPurchases}</p>`;
                }
                
                // Description & Cost
                const costText = isMaxed && item.id !== 'bong_master' ? 'MAXED' : `${formatNumber(cost)} 💰`;
                
                shopItemDiv.innerHTML = `
                    ${titleHtml}
                    <div class="flex-grow">
                        <p class="text-slate-400 text-sm mb-3">${item.desc}</p>
                        ${statusHtml}
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t border-slate-700">
                        <p class="text-2xl font-extrabold ${canAfford ? 'text-yellow-400' : 'text-red-400'}">${costText}</p>
                        <button class="shop-buy-button" id="buy-${item.id}" 
                                data-id="${item.id}"
                                ${isMaxed && item.id !== 'bong_master' ? 'disabled' : ''}
                                ${!canAfford && item.id !== 'bong_master' ? 'disabled' : ''}>
                            ${item.id === 'bong_master' ? 'CLEAN!' : 'BUY'}
                        </button>
                    </div>
                `;
                
                shopItemsContainer.appendChild(shopItemDiv);
                
                // Attach event listener
                const buyButton = document.getElementById(`buy-${item.id}`);
                if (buyButton) {
                    buyButton.addEventListener('click', () => purchaseItem(item.id));
                }
            });
        }
        
        function purchaseItem(itemId) {
            const item = SHOP_ITEMS_CONFIG.find(i => i.id === itemId);
            if (!item) return;
            
            const currentLevel = getLevel(itemId);
            const cost = calculateCost(item.baseCost, currentLevel);
            
            if (gameState.gold < cost) {
                playNegativeSound();
                return;
            }
            
            if (itemId !== 'bong_master' && itemId !== 'golden_bong' && currentLevel >= item.maxPurchases) {
                playNegativeSound();
                return;
            }
            
            // Deduct cost
            gameState.gold -= cost;
            playCoinSound();
            
            // Apply effect
            switch(itemId) {
                case 'gramBoost':
                case 'speedBoost':
                case 'coinChance':
                case 'coinAmount':
                case 'doubleChance':
                case 'reloadSpeed':
                    gameState[itemId + 'Level']++;
                    checkAchievements(); // Check if max level achievement is unlocked
                    break;
                case 'bong_master':
                    // Cleans bong resin only
                    gameState.bongDirtiness = 0;
                    break;
                case 'golden_bong':
                    gameState.hasGoldenBong = true;
                    // Apply visual update immediately
                    bongSvg.classList.add('golden-bong');
                    checkAchievements();
                    break;
            }
            
            updateUI();
            saveGame();
        }

        // --- ACHIEVEMENTS ---
        
        // Function to check all achievement conditions
        function checkAchievements() {
            ACHIEVEMENTS_CONFIG.forEach(achievement => {
                const state = gameState.achievements[achievement.id];
                if (!state.unlocked) {
                    if (achievement.check(gameState)) {
                        state.unlocked = true;
                        showAchievementNotification(achievement.name, achievement.reward);
                        
                        // Give reward only once
                        if (!state.rewarded) {
                            gameState.gold += achievement.reward;
                            gameState.goldEarnedTotal += achievement.reward;
                            state.rewarded = true;
                            // Play a coin sound on reward (if not a major level up already)
                            if (gameState.currentLevel <= 1) { 
                                playCoinSound();
                            }
                        }
                    }
                }
            });
        }
        
        // --- NOTIFICATIONS ---
        
        function showAchievementNotification(name, reward) {
            achievementNameDisplay.textContent = name;
            achievementRewardDisplay.textContent = `+${reward} Gold Reward!`;
            achievementNotification.classList.remove('hidden');
            
            // Show then hide
            requestAnimationFrame(() => {
                achievementNotification.classList.add('show');
            });
            
            setTimeout(() => {
                achievementNotification.classList.remove('show');
                setTimeout(() => {
                    achievementNotification.classList.add('hidden');
                }, 500); // Wait for transition to finish
            }, 5000);
        }
        
        function showLevelUpNotification(newLevel) {
            const rank = getCurrentRank();
            levelUpNameDisplay.textContent = `Level ${newLevel} (${rank})`;
            levelUpNotification.classList.remove('hidden');
            
            // Show then hide
            requestAnimationFrame(() => {
                levelUpNotification.classList.add('show');
            });
            
            setTimeout(() => {
                levelUpNotification.classList.remove('show');
                setTimeout(() => {
                    levelUpNotification.classList.add('hidden');
                }, 500); // Wait for transition to finish
            }, 4000);
        }

        function renderAchievements() {
            achievementsContainer.innerHTML = '';
            
            ACHIEVEMENTS_CONFIG.forEach(achievement => {
                const state = gameState.achievements[achievement.id];
                
                const card = document.createElement('div');
                card.className = `achievement-card p-4 rounded-xl shadow-lg ${state.unlocked ? 'unlocked' : ''}`;
                
                card.innerHTML = `
                    <h5 class="text-xl font-extrabold ${state.unlocked ? 'text-white' : 'text-slate-400'}">
                        ${state.unlocked ? '🏆 ' : '🔒 '}${achievement.name}
                    </h5>
                    <p class="text-slate-300 mt-1">${achievement.desc}</p>
                    <p class="text-sm font-bold mt-2 ${state.unlocked ? 'text-yellow-400' : 'text-slate-500'}">
                        Reward: ${achievement.reward} 💰
                    </p>
                `;
                
                achievementsContainer.appendChild(card);
            });
        }

        // --- VISUAL EFFECTS ---
        
        function spawnSmokeExhale() {
            const smoke = document.createElement('div');
            smoke.className = 'smoke-exhale';
            gameArea.appendChild(smoke);
            
            setTimeout(() => {
                smoke.remove();
            }, 1500);
        }
        
        function spawnHitMessage(text, isCritical) {
            const message = document.createElement('div');
            message.className = 'hit-message';
            
            // Apply gradient/color based on critical status
            if (isCritical) {
                message.className += ' text-yellow-400 text-3xl glow-text';
                message.style.textShadow = '0 0 5px rgba(250, 204, 21, 0.8), 0 0 15px rgba(250, 204, 21, 0.5)';
            } else {
                message.className += ' text-emerald-300 text-2xl readable-text-shadow';
            }
            
            message.textContent = text;
            gameArea.appendChild(message);
            
            // Apply animation and remove
            requestAnimationFrame(() => {
                message.style.animation = 'fade-up-left 1.2s ease-out forwards';
            });
            
            setTimeout(() => {
                message.remove();
            }, 1200);
        }

        // --- NAVIGATION / VIEWS ---

        function showView(viewId) {
            const views = [infoView, testView, minigameView, shopView, achievementsView];
            views.forEach(view => {
                if (view) {
                    view.classList.add('hidden');
                }
            });
            
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            if (viewId === 'shopView') {
                renderShopItems();
            }
            if (viewId === 'achievementsView') {
                renderAchievements();
            }
            
            updateUI();
        }

        function handleFactButtonClick(event) {
            const factKey = event.target.dataset.fact;
            factDisplay.innerHTML = FACTS[factKey];
        }


        // --- LOCAL STORAGE ONLY ---
        
        const SAVE_KEY = 'eeds_clicker_save';
        const userId = 'eeds_anon_user'; // Default offline user ID
        
        function saveGame() {
            const saveObject = {
                ...gameState,
                lastSaveTime: Date.now()
            };
            
            // Save to Local Storage
            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveObject));
            } catch (e) {
                console.warn("Local storage save failed:", e);
            }
        }

        function loadGame(currentUserId) {
            let loadedData = null;

            // Load from Local Storage
            try {
                const localData = localStorage.getItem(SAVE_KEY);
                if (localData) {
                    loadedData = JSON.parse(localData);
                    console.log("Game loaded from Local Storage.");
                }
            } catch (e) {
                console.warn("Local storage load failed:", e);
            }
            
            // Final apply and initialize
            applyLoadedState(loadedData);
            loadingStatus.classList.add('hidden');
            // Immediate save to ensure new save time is recorded
            saveGame();
        }

        function applyLoadedState(loadedData) {
            if (loadedData) {
                // Simple merge logic: copy all keys from loadedData to gameState
                Object.assign(gameState, loadedData);
                
                // Special handling for nested achievement object to preserve structure
                if (loadedData.achievements) {
                     // Recreate achievement object based on config to ensure all achievements are present
                    gameState.achievements = ACHIEVEMENTS_CONFIG.reduce((acc, achievement) => {
                        acc[achievement.id] = loadedData.achievements[achievement.id] || { unlocked: false, rewarded: false };
                        return acc;
                    }, {});
                }

                // If CST was active on save, restart the timer
                if (gameState.isCriticalSmokeTime) {
                    const remainingTime = gameState.cstEndTime - Date.now();
                    if (remainingTime > 0) {
                         // Restart CST
                        startCriticalSmokeTime();
                    } else {
                        // CST expired while offline
                        gameState.isCriticalSmokeTime = false;
                        gameState.cstEndTime = 0;
                    }
                }
            }
            
            // Final initialization step
            if (gameState.hits > 0) {
                showView('minigameView'); // Start on game view if already playing
            } else {
                showView('infoView'); // Start on info view for new players
            }
            updateUI();
            checkAchievements();
        }

        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // Load Game directly using Local Storage fallback
            loadingStatus.textContent = 'Loading game data (Offline Mode)...';
            loadingStatus.classList.remove('hidden');
            loadGame(userId); 

            // Start character swaying animation initially
            if (eedsCharacter) {
                eedsCharacter.classList.add('swaying');
            }

            // Event listener for "Begin Test" button to switch to the minigame view
            document.getElementById('beginTestButton').addEventListener('click', () => {
                showView('minigameView');
            });

            // Add event listeners for navigation buttons
            document.getElementById('navInfoButton').addEventListener('click', () => showView('infoView'));
            document.getElementById('navMinigameButton').addEventListener('click', () => showView('minigameView'));
            document.getElementById('navShopButton').addEventListener('click', () => showView('shopView'));
            document.getElementById('navAchievementsButton').addEventListener('click', () => showView('achievementsView')); 
            
            // Add event listeners for fact buttons
            document.querySelectorAll('.fact-button[data-fact]').forEach(button => {
                button.addEventListener('click', handleFactButtonClick);
            });


            // Re-attach click listener for eedsCharacter 
            if (eedsCharacter) {
                eedsCharacter.addEventListener('click', triggerBongHit);
            }

            // Add listener for the change water button
            if (changeWaterButton) {
                changeWaterButton.addEventListener('click', changeBongWater);
            }
        });
    </script>
</body>
</html>
