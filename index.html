<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EedsClicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; 
            min-height: 10vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background-color: transparent; 
            border-radius: 16px;
            padding: 32px;
            max-width: 1000px; 
            width: 100%;
            position: relative; 
            z-index: 10;
        }
        .glow-text {
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3), 0 0 15px rgba(16, 185, 129, 0.8);
        }
        .readable-text-shadow {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8), 0 0 5px rgba(255, 255, 255, 0.2);
        }
        .leaf-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80vmin; 
            height: 80vmin;
            transform: translate(-50%, -50%) rotate(25deg);
            opacity: 0.1; 
            filter: drop-shadow(0 0 15px #059669); 
            z-index: -1; 
            pointer-events: none; 
        }
        .fact-button, .nav-button, .shop-buy-button {
            padding: 12px 24px;
            border-radius: 9999px; 
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 4px;
        }
        .fact-button {
            background-image: linear-gradient(to right, #10b981, #059669); 
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .fact-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.8);
            background-image: linear-gradient(to right, #059669, #10b981);
        }
        .cta-button {
            background-image: linear-gradient(to right, #a855f7, #9333ea); 
            color: white;
            padding: 16px 40px;
            border-radius: 9999px;
            font-size: 1.25rem; 
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 6px 25px rgba(168, 85, 247, 0.6);
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cta-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.9);
        }
        .fact-box, .result-box {
            background-color: transparent; 
            color: #f8fafc; 
            padding: 20px;
            border-radius: 12px;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.125rem;
            font-style: italic;
            transition: all 0.3s ease-in-out;
            border-left: 5px solid #10b981; 
            text-align: center;
        }
        
        /* CHARACTER ANIMATIONS (UPDATED) */
        @keyframes sway {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(0, -5px) rotate(3deg); } 
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        #eeds-character {
            cursor: pointer;
            user-select: none; /* Prevent text selection */
            transition: transform 0.1s, rotate 0.3s ease-out;
        }
        #eeds-character.swaying {
            animation: sway 2.5s infinite ease-in-out;
        }
        #eeds-character.smoking {
            /* Lean forward/right slightly to hit the bong */
            transform: translateX(20px) translateY(10px) scale(1.05); 
            animation: none; 
        }
        
        /* NEW: Bong Hit Recoil Animation */
        @keyframes hit-recoil {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(5px) rotate(1deg) scale(0.98); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        #eeds-character.recoil-on-hit {
            animation: hit-recoil 0.2s ease-out;
        }

        /* NEW: Refill animation for character */
        #eeds-character.refilling {
            /* Lean more intensely for the refill/scooping motion */
            transform: translateX(30px) translateY(15px) rotate(10deg) scale(1.05); 
            animation: none; 
        }

        @keyframes refill {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #refill-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 2rem;
            font-weight: bold;
            animation: refill 0.5s infinite alternate;
            z-index: 50;
            pointer-events: none;
        }
        
        @keyframes puff {
            0% { transform: translate(-50%, 0) scale(0.2); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
        }
        .smoke-puff {
            position: absolute;
            bottom: 232px; 
            left: 50%;
            transform: translate(-50%, 0);
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            filter: blur(5px);
            pointer-events: none;
            animation: puff 1s ease-out forwards;
        }

        @keyframes exhale {
            0% { transform: translate(0, 0) scale(0.1); opacity: 0.5; }
            100% { transform: translate(30px, -80px) scale(1.5); opacity: 0; }
        }
        .smoke-exhale {
            position: absolute;
            bottom: 232px; 
            right: 40%;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            filter: blur(8px);
            pointer-events: none;
            animation: exhale 1.5s ease-out forwards;
            z-index: 20;
        }

        /* Hit Feedback Animations (UPDATED for better separation) */
        @keyframes fade-up-left {
            0% { opacity: 0; transform: translate(-0px, 10px) scale(0.8); } 
            50% { opacity: 1; transform: translate(-30px, -10px) scale(1); } 
            100% { opacity: 0; transform: translate(-60px, -50px) scale(1.2); } 
        }
        
        /* NEW: Second animation for Gold feedback */
        @keyframes fade-up-right {
            0% { opacity: 0; transform: translate(0, 10px) scale(0.8); } 
            50% { opacity: 1; transform: translate(30px, -10px) scale(1); } 
            100% { opacity: 0; transform: translate(60px, -50px) scale(1.2); } 
        }

        /* Updated positioning for hit-message */
        .hit-message {
            position: absolute;
            top: 50%;
            left: 50%; 
            transform: translate(-50%, -50%); /* Base position center */
            font-weight: 800;
            white-space: nowrap;
            pointer-events: none;
            z-index: 50;
            opacity: 0; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* Make it pop */
        }

        .weed-game-bg {
            background-color: #1c322b;
            background-image: radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.2) 0%, rgba(30, 41, 59, 0) 70%), 
                              repeating-linear-gradient(135deg, rgba(20, 83, 45, 0.1) 0px, rgba(20, 83, 45, 0.1) 1px, transparent 1px, transparent 5px);
            border: 3px solid #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
        }
        
        /* CRITICAL SMOKE TIME STYLE (EDITED: Gold border, less obstructive) */
        .weed-game-bg.critical-smoke {
            border: 5px solid #facc15; /* Gold/Yellow border */
            box-shadow: 0 0 30px rgba(250, 204, 21, 0.6), 0 0 10px rgba(255, 255, 255, 0.2); /* Gold glow effect */
            background-color: #2b2a1c; /* Gold-tinged dark background */
        }
        
        /* The main CST overlay container is now just a container for the banner, not full-screen */
        #criticalSmokeTimeOverlay {
            pointer-events: none; 
        }
        /* END NEW CRITICAL SMOKE TIME STYLE */

        .shop-item {
            background-color: rgba(30, 41, 59, 0.7); 
            border: 2px solid #a855f7;
        }
        .shop-buy-button {
            background-color: #facc15;
            color: #374151;
            box-shadow: 0 2px 10px rgba(250, 204, 21, 0.6);
        }
        .shop-buy-button:hover:not(:disabled) {
            background-color: #fcd34d;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.9);
        }
        .shop-buy-button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .stat-card {
            background-color: rgba(30, 41, 59, 0.8);
            border: 2px solid #a855f7;
            padding: 16px;
            border-radius: 12px;
        }
        .stat-item {
            padding: 8px 0;
            border-bottom: 1px dashed #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .level-bar-container {
            height: 12px;
            background-color: #4a5568;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 4px;
        }
        .level-bar {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease-out;
        }

        /* Achievement Notification Styles */
        #achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #facc15, #f59e0b);
            color: #374151;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            font-weight: 700;
            z-index: 100;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.5s, transform 0.5s ease-out;
            max-width: 300px;
        }
        #achievement-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Level Up Notification Styles */
        #level-up-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start off-screen vertically */
            background: linear-gradient(135deg, #a855f7, #9333ea);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(147, 51, 234, 0.6);
            font-weight: 800;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s ease-out;
            max-width: 400px;
            text-align: center;
            border: 3px solid #d8b4fe;
        }
        #level-up-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* Move to screen center */
        }

        .achievement-card {
            background-color: rgba(30, 41, 59, 0.7);
            border: 2px solid #1e293b;
        }
        .achievement-card.unlocked {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        /* Golden Bong Style */
        .golden-bong .bong-glass {
            fill: url(#goldGradient) !important;
            stroke: #ffd700 !important;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }
    </style>
</head>
<body>
    
    <div id="cannabis-bg-overlay" 
         class="fixed inset-0 z-[-2]" 
         style="background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); opacity: 1; background-size: cover; background-attachment: fixed; background-position: center;">
    </div>

    <svg id="cannabis-leaf" class="leaf-bg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M50 0 L40 20 L20 15 L35 40 L20 60 L50 90 L80 60 L65 40 L80 15 L60 20 Z" fill="#10b981"/>
    </svg>

    <div class="container">
        
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-4 tracking-wider text-center glow-text readable-text-shadow">
            EEDSCLICKER <span class="text-emerald-400">(ALPHA 1.0)</span>
        </h1>
        <p class="text-slate-200 mb-8 text-lg text-center readable-text-shadow">
            A game about Eeds smoking, with persistant upgrades.
        </p>

        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button id="navInfoButton" class="fact-button nav-button">Info & Stats</button>
            <button id="navMinigameButton" class="fact-button nav-button !bg-fuchsia-600 hover:!bg-fuchsia-700 !shadow-fuchsia-500/50">
                The Game
            </button>
            <button id="navShopButton" class="fact-button nav-button !bg-yellow-500 hover:!bg-yellow-600 !shadow-yellow-500/50">
                Shop
            </button>
            <button id="navAchievementsButton" class="fact-button nav-button !bg-blue-500 hover:!bg-blue-600 !shadow-blue-500/50">
                Achievements
            </button>
        </div>

        <div id="achievement-notification" class="hidden">
            <p class="text-xs">🏆 ACHIEVEMENT UNLOCKED!</p>
            <p id="achievement-name" class="text-xl mt-1"></p>
            <p id="achievement-reward" class="text-sm mt-1 text-black/80"></p>
        </div>
        
        <div id="level-up-notification" class="hidden">
            <p class="text-sm">🚀 EEDSCLICKER RANK INCREASED!</p>
            <p id="level-up-name" class="text-2xl mt-1"></p>
        </div>
        <div id="loadingStatus" class="text-center text-white text-lg readable-text-shadow p-4 bg-emerald-600/50 rounded-lg mb-6 hidden">
            </div>

        <div id="infoView" class="hidden">
            <div class="flex flex-wrap justify-center gap-4 mb-10">
                <button class="fact-button" data-fact="mission">How does it work?</button>
                <button class="fact-button" data-fact="founding">Is it fake?</button>
                <button class="fact-button" data-fact="product">Bong or Joint</button>
                <button class="fact-button" data-fact="mascot">Contact us</button>
            </div>

            <div id="factDisplay" class="fact-box readable-text-shadow">
                <p class="text-slate-300">Select a category above to learn more, or click Play Now to start the game!</p>
            </div>
            
            <div class="flex justify-center mt-8">
                <button id="beginTestButton" class="cta-button">PLAY NOW!</button>
            </div>
        </div>

        <div id="testView" class="hidden">
            <p class="text-white text-center readable-text-shadow">Quick test is available by clicking "Begin Test" from the Info tab!</p>
            <p class="text-slate-400 text-center readable-text-shadow mt-2">Use the Mini-Game tab to play and earn coins.</p>
        </div>
        
        <div id="minigameView" class="hidden text-center grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-4">
                <h2 class="text-3xl font-extrabold text-white tracking-wider glow-text readable-text-shadow">
                    EEDSCLICKER (ALPHA 1.0)
                </h2>

                <div id="gameArea" class="weed-game-bg flex justify-center items-end relative h-[448px] w-full overflow-hidden rounded-xl">
                    
                    <div id="counters" class="absolute top-0 left-0 right-0 p-2 flex justify-around text-white font-bold text-lg bg-black/50 rounded-t-xl readable-text-shadow">
                        <div id="hit-counter">Hits: 0</div>
                        <div id="gram-counter">Grams Smoked: 0.0g</div>
                        <div id="coin-counter" class="text-yellow-400">Coins: 0 💰</div> 
                    </div>

                    <div class="absolute top-[55px] left-0 right-0 px-4">
                        <div class="flex justify-between text-xs font-semibold text-white/80 readable-text-shadow">
                            <span id="level-display">LEVEL 1</span>
                            <span id="xp-display">0 / 50 XP</span>
                        </div>
                        <div class="level-bar-container border-2 border-emerald-400">
                            <div id="level-bar" class="level-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div id="refill-loader" class="hidden">REFILLING...</div>
                    
                    <div id="criticalSmokeTimeOverlay" class="absolute top-[110px] left-0 right-0 px-4 hidden z-40">
                        <div class="bg-black/60 p-2 rounded-xl border-2 border-yellow-500 text-center">
                            <p class="text-xl font-extrabold text-yellow-400 glow-text readable-text-shadow">
                                CRITICAL SMOKE TIME!
                            </p>
                            <p id="cst-timer" class="text-sm font-bold text-yellow-300 mt-1 readable-text-shadow">
                                5.0s remaining
                            </p>
                        </div>
                    </div>
                    <svg id="cosmic-bong" class="w-24 h-48 absolute bottom-[40px] right-1/2 translate-x-1/2 mr-4" viewBox="0 0 100 250" fill="none" xmlns="http://www.w3.org/2000/svg" style="transition: transform 0.1s ease-out;">
                        <defs>
                            <radialGradient id="glassGradient" cx="50%" cy="50%" r="50%" fx="60%" fy="60%">
                                <stop offset="0%" style="stop-color:rgb(255,255,255);stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:rgb(192,236,255);stop-opacity:0.3" />
                            </radialGradient>
                            <linearGradient id="waterGradient" x1="0" y1="200" x2="0" y2="250" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#3b82f6"/>
                                <stop offset="1" stop-color="#0ea5e9" stop-opacity="0.5"/>
                            </linearGradient>
                            <linearGradient id="goldGradient" x1="0" y1="0" x2="0" y2="250" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" style="stop-color:#ffe495;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#ffd700;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#c8b04a;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M10 250 Q 5 210, 25 200 H 75 Q 95 210, 90 250 Z" class="bong-glass" fill="url(#glassGradient)" stroke="#93c5fd" stroke-width="2" stroke-opacity="0.6"/>
                        <path d="M15 250 Q 10 220, 30 210 H 70 Q 90 220, 85 250 Z" fill="url(#waterGradient)"/>
                        
                        <path id="water-dirt-overlay" d="M15 250 Q 10 220, 30 210 H 70 Q 90 220, 85 250 Z" fill="#6d4128" style="opacity: 0; mix-blend-mode: multiply; transition: opacity 0.5s;"/>

                        <rect id="bong-main-tube" x="35" y="20" width="30" height="190" class="bong-glass" fill="url(#glassGradient)" stroke="#93c5fd" stroke-width="2" rx="5"/>
                        <rect id="dirt-overlay" x="35" y="20" width="30" height="190" fill="#6d4128" rx="5" style="mix-blend-mode: multiply; opacity: 0; transition: opacity 0.5s;"/>

                        <rect x="30" y="10" width="40" height="15" fill="#9333ea" stroke="#d8b4fe" stroke-width="2" rx="7"/>
                        <rect x="65" y="195" width="5" height="15" fill="#4b5563" transform="rotate(15 65 195)"/> 
                        
                        <circle cx="78" cy="180" r="10" fill="#facc15" stroke="#f59e0b" stroke-width="2"/>
                        <circle id="weed-stash" cx="78" cy="180" r="8" fill="#10b981" style="transition: all 0.1s ease-out;"/>
                        <circle id="burning-ember" cx="78" cy="180" r="10" fill="#ff4400" opacity="0" style="transition: opacity 0.1s; filter: blur(2px); pointer-events: none;"/>
                        
                        <circle cx="50" cy="225" r="5" fill="#e0f2fe" fill-opacity="0.8"/>
                        <circle cx="40" cy="235" r="3" fill="#e0f2fe" fill-opacity="0.8"/>
                    </svg>

                    <svg id="eeds-character" class="w-48 h-80 absolute bottom-[-48px] right-1/2 translate-x-1/2 ml-4" viewBox="0 0 150 200" fill="none" xmlns="http://www.w3.org/2000/svg" style="transition: transform 0.2s, rotate 0.2s;">
                        <circle cx="75" cy="20" r="15" fill="#fef08a" stroke="#f59e0b" stroke-width="2"/>
                        <circle cx="70" cy="18" r="1.5" fill="#333"/>
                        <circle cx="80" cy="18" r="1.5" fill="#333"/>
                        <path id="eeds-mouth" d="M80 25 Q 85 28, 90 25" stroke="#a855f7" stroke-width="1.5" fill="none"/>
                        <path d="M68 8 Q 75 -5, 82 8 C 80 15, 75 18, 70 15 Z" fill="#444" stroke="#333" stroke-width="1"/>
                        <rect x="65" y="35" width="20" height="85" fill="#10b981" rx="5"/>
                        <path d="M75 50 L95 70 L100 100" stroke="#fef08a" stroke-width="5" stroke-linecap="round" fill="none"/>
                        <line x1="75" y1="120" x2="55" y2="150" stroke="#fef08a" stroke-width="5" stroke-linecap="round"/>
                        <line x1="75" y1="120" x2="95" y2="150" stroke="#fef08a" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                    
                    <p id="click-instruction" class="absolute bottom-[10px] left-1/2 transform -translate-x-1/2 text-lg font-bold text-lime-300 readable-text-shadow z-30 tracking-wider uppercase">
                        CLICK TO TAKE A HIT!
                    </p>

                </div>

                <div class="flex justify-center mt-4 space-x-4">
                    <div class="p-3 bg-red-800/50 text-white rounded-lg font-semibold readable-text-shadow flex items-center">
                        <span class="text-xl mr-2">💧</span> Water Dirt: <span id="stat-water-dirt" class="ml-1">0 / 50</span>
                    </div>
                    <button id="changeWaterButton" class="cta-button !text-base !py-3 !px-6 !bg-blue-600 hover:!bg-blue-700 !shadow-blue-500/50" disabled>
                        Change Water (100💰)
                    </button>
                </div>
                
                <div id="win-bar" class="hidden mt-4 p-4 rounded-lg text-center font-extrabold text-2xl readable-text-shadow" 
                     style="background: linear-gradient(90deg, #facc15, #f59e0b, #facc15); box-shadow: 0 0 20px #facc15;">
                    </div>
            </div>

            <div class="lg:col-span-1 space-y-4">
                <h3 class="text-2xl font-bold text-white text-center readable-text-shadow">
                    SMOKING STATS
                </h3>
                <div class="stat-card">
                    <p class="text-lg font-bold text-yellow-400 text-center mb-2">
                        LEVEL <span id="current-level-stat">1</span>
                    </p>
                    <div class="stat-item !border-b-2 !border-fuchsia-500 mb-2">
                        <span class="text-slate-300 font-extrabold text-fuchsia-400">CURRENT RANK</span>
                        <span id="stat-rank" class="font-extrabold text-white">Bud Novice</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Total Hits Taken</span>
                        <span id="stat-hits-taken" class="font-extrabold text-emerald-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Total Gold Earned</span>
                        <span id="stat-gold-earned" class="font-extrabold text-yellow-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Biggest Hit (g)</span>
                        <span id="stat-biggest-hit" class="font-extrabold text-red-400">0.0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">XP Until Next Level</span>
                        <span id="stat-xp-to-next" class="font-extrabold text-fuchsia-400">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="text-slate-300">Bong Resin (Penalty)</span>
                        <span id="stat-dirtiness" class="font-extrabold text-red-400">0%</span>
                    </div>
                </div>
            </div>
            </div>
        <div id="shopView" class="hidden">
            <h2 class="text-3xl font-extrabold text-white mb-4 tracking-wider glow-text readable-text-shadow text-center">
                EEDSCLICKER UPGRADES
            </h2>
            
            <div class="text-center mb-8 bg-black/30 p-4 rounded-xl border-b-4 border-yellow-500 shadow-lg">
                <p class="text-4xl font-extrabold text-yellow-400 readable-text-shadow">
                    <span id="shop-coin-counter">0</span> 💰
                </p>
                <p class="text-lg text-slate-300 font-semibold">Your Current Balance</p>
            </div>
            
            <p class="text-slate-300 mb-8 text-center readable-text-shadow">
                Spend your gold coins to enhance Eeds' smoking power and efficiency!
            </p>

            <div id="shopItemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                
            </div>
        </div>
        
        <div id="achievementsView" class="hidden">
            <h2 class="text-3xl font-extrabold text-white mb-6 tracking-wider glow-text readable-text-shadow text-center">
                Smoking Milestones 🏆
            </h2>

            <div id="achievementsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">

            </div>
        </div>

    </div>

    <script>
        // =========================================================================
        // !!! LOCAL STORAGE CONFIGURATION (OFFLINE FRIENDLY) !!!
        // =========================================================================
        // Removed Firebase Configuration
        // =========================================================================

        // --- GLOBAL CONSTANTS (UPDATED BASE_MIN_HIT and BASE_MAX_HIT) ---
        const FACTS = {
            mission: "Simply click on the Begin Test button, and take a test to find out the true amount of Cannabis Eedspeaks smoked in a week.",
            founding: "Everything shown on the website is correct information obtained after years of years of regular investigation.",
            product: "Eedspeaks usually only smokes from a Bong, but he isn't against a well-rolled L joint. <br><br><strong>Fun Fact:</strong> Eeds can smoke an L joint in 5 minutes.",
            mascot: "For all inquiries, contact Eeds directly via his galactic communicator at **eedspeaks@cosmiccloud.net** or send a transmission through the nebula."
        };

        const WIN_GRAMS = 20.0;
        const BASE_GOLD_PER_GRAM = 100; // FIXED: Changed from 10 to 100 so 0.01g hit gives 1 gold (0.01 * 100 = 1).
        const BASE_BONUS_DROP_CHANCE = 0.2;
        const BASE_BONUS_DROP_AMOUNT = 10;
        const BASE_DOUBLE_HIT_CHANCE = 0.1;

        // --- EXISTING: SINGLE CRITICAL HIT CONSTANTS (0.01%) ---
        const CRITICAL_HIT_CHANCE = 0.01; // 1% chance
        const CRITICAL_HIT_MULTIPLIER = 2.5; // 2.5x multiplier for grams and gold
        // -----------------------------------

        // --- NEW: CRITICAL SMOKE TIME CONSTANTS (5% Event) ---
        const CRITICAL_SMOKE_TIME_CHANCE = 0.05; // 5% chance
        const CRITICAL_SMOKE_TIME_DURATION = 5000; // 5 seconds
        const CRITICAL_SMOKE_TIME_GRAM_MULTIPLIER = 2.0;
        const CRITICAL_SMOKE_TIME_GOLD_MULTIPLIER = 3.0;
        const CST_SMOKE_DELAY_REDUCTION = 500; // NEW: Reduce delay by 500ms
        const CST_MIN_SMOKE_DELAY = 100; // NEW: Minimum delay during CST
        // ------------------------------------------

        // --- UPDATED MIN/MAX HIT VALUES ---
        const BASE_MIN_HIT = 0.01; // Changed from 0.1
        const BASE_MAX_HIT = 0.2; // Changed from 0.5
        // ----------------------------------
        
        const BASE_SMOKE_DELAY = 1000;
        const BASE_XP = 50;
        const XP_RATE = 1.6;
        const MILESTONE_REWARD = 150;
        const MAX_DIRTINESS = 100;
        const DIRTINESS_PENALTY_PER_UNIT = 0.005;
        const BONG_MASTER_COST = 100;
        const MAX_WATER_DIRTINESS = 100;
        const WATER_CHANGE_COST = 100;
        const GOLDEN_BONG_COST = 2500;
        const GOLDEN_BONG_MULTIPLIER = 3;
        const MAX_HITS_PER_BOWL = 10;
        const BASE_REFILL_DURATION = 2000; // 2 seconds

        // --- SHOP ITEM CONFIGURATION (FIXED IDS TO CAMELCASE FOR LEVELING) ---
        const SHOP_ITEMS_CONFIG = [
            { id: 'gramBoost', name: 'Grinder Upgrade', desc: 'Increases Max Hit by +0.1g', baseCost: 50, gramBoost: 0.1, maxPurchases: 5, icon: '🔥' },
            { id: 'speedBoost', name: 'Fast Lighter', desc: 'Reduces Hit Delay by -10%', baseCost: 100, speedBoost: 0.1, maxPurchases: 5, icon: '⚡' },
            { id: 'coinChance', name: 'Hydroponic Setup', desc: 'Increases Bonus Gold Chance by +5%', baseCost: 150, coinChanceBoost: 0.05, maxPurchases: 4, icon: '🌱' },
            { id: 'coinAmount', name: 'Munchies Fund', desc: 'Increases Bonus Gold Amount by +10', baseCost: 200, coinAmountBoost: 10, maxPurchases: 5, icon: '🍔' },
            { id: 'doubleChance', name: 'Concentrate Cart', desc: 'Increases Double Hit Chance by +2%', baseCost: 300, doubleChanceBoost: 0.02, maxPurchases: 5, icon: '🍯' },
            { id: 'reloadSpeed', name: 'Faster Reload', desc: 'Increases bowl reload speed by 10%', baseCost: 150, reloadSpeedBoost: 0.1, maxPurchases: 4, icon: '💨' },
            { id: 'bong_master', name: 'Bong Master', desc: 'Instantly cleans the bong glass/resin.', baseCost: BONG_MASTER_COST, maxPurchases: 99, icon: '🧼' },
            { id: 'golden_bong', name: 'Golden Bong', desc: `Triples all gold income!`, baseCost: GOLDEN_BONG_COST, maxPurchases: 1, icon: '🌟' },
        ];

        // --- ACHIEVEMENTS CONFIGURATION ---
        const ACHIEVEMENTS_CONFIG = [
            { id: 'first_hit', name: 'First Toke', desc: 'Take your very first hit.', reward: 10, check: (state) => state.hits >= 1 },
            { id: 'baby_lungs', name: 'Baby Lungs', desc: 'Smoke 1.0g of Eeds.', reward: 50, check: (state) => state.gramsSmoked >= 1.0 },
            { id: 'half_ounce', name: 'Half Ounce Hitter', desc: 'Smoke 14.0g of Eeds.', reward: 500, check: (state) => state.gramsSmoked >= 14.0 },
            { id: 'milestone', name: 'Milestone Achieved', desc: `Smoke the goal of ${WIN_GRAMS}g of Eeds.`, reward: 1000, check: (state) => state.gramsSmoked >= WIN_GRAMS, isSecret: true },
            { id: 'level_10', name: 'Intermediate Smoker', desc: 'Reach Level 10.', reward: 200, check: (state) => state.level >= 10 },
            { id: 'level_50', name: 'Connoisseur', desc: 'Reach Level 50.', reward: 750, check: (state) => state.level >= 50 },
            { id: 'big_spender', name: 'Big Spender', desc: 'Spend 500 total coins.', reward: 100, check: (state) => state.stats.goldSpent >= 500 },
            { id: 'money_bags', name: 'Money Bags', desc: 'Earn 1000 total coins.', reward: 150, check: (state) => state.stats.goldEarned >= 1000 },
            { id: 'super_hit', name: 'Super Hit', desc: 'Take a single hit of 0.5g or more.', reward: 200, check: (state) => state.stats.biggestHit >= 0.5 },
            { id: 'max_grinder', name: 'Max Grinder', desc: 'Max out the Grinder Upgrade.', reward: 100, check: (state) => state.upgrades.gramBoost >= SHOP_ITEMS_CONFIG.find(i => i.id === 'gramBoost').maxPurchases },
            { id: 'clean_water', name: 'Clean Living', desc: 'Change the water 10 times.', reward: 100, check: (state) => state.stats.waterChanges >= 10 },
            { id: 'bong_master_clean', name: 'Bong Master Dedication', desc: 'Use the Bong Master upgrade 5 times.', reward: 150, check: (state) => state.stats.bongMasterUses >= 5 },
            { id: 'golden_bong_buy', name: 'Golden Ticket', desc: 'Purchase the Golden Bong.', reward: 500, check: (state) => state.upgrades.golden_bong >= 1, isSecret: true },
        ];

        const LEVEL_RANKS = [
            { level: 1, name: "Bud Novice" },
            { level: 5, name: "Joint Roller" },
            { level: 10, name: "Bong Ripper" },
            { level: 25, name: "Half-Ounce Hitter" },
            { level: 50, name: "The Connoisseur" },
            { level: 100, name: "Eeds Apprentice" },
            { level: 200, name: "Eeds Master" },
            { level: 500, name: "Cosmic Smoker" }
        ];

        // --- GAME STATE ---
        let gameState = {
            // userId: null, // Removed for offline play
            // isAuthenticated: false, // Removed for offline play
            hits: 0,
            gramsSmoked: 0.0,
            coins: 0,
            dirtiness: 0, // Bong resin build-up (0-100)
            waterDirtiness: 0, // Water filthiness (0-MAX_WATER_DIRTINESS)
            hitsSinceRefill: 0,
            level: 1,
            xp: 0,
            upgrades: SHOP_ITEMS_CONFIG.reduce((acc, item) => {
                acc[item.id] = 0;
                return acc;
            }, {}),
            achievements: ACHIEVEMENTS_CONFIG.reduce((acc, item) => {
                acc[item.id] = false;
                return acc;
            }, {}),
            stats: {
                hitsTaken: 0,
                goldEarned: 0,
                goldSpent: 0,
                biggestHit: 0.0,
                waterChanges: 0,
                bongMasterUses: 0,
            },
            isCSTActive: false,
            isRefilling: false,
            // Add a timestamp for last save/load time
            lastUpdate: Date.now()
        };
        let bongHitTimeout;
        let cstTimeout;
        let cstTimerInterval;

        // --- TONE.JS AUDIO SYNTHS ---
        let coinSynth;
        let levelUpToneSynth;
        let achievementSynth;
        let bongHitSynth; // For the actual hit sound
        let kickSynth; // NEW: For the punchy sound

        // Initialize Tone.js components globally
        try {
            // Tone.js Sound Initializers
            coinSynth = new Tone.PolySynth(Tone.DuoSynth).toDestination();
            levelUpToneSynth = new Tone.PolySynth(Tone.AMSynth).toDestination();
            
            // Initialize the achievement sound synth (FIXED: Changed to PolySynth to allow chord)
            achievementSynth = new Tone.PolySynth(Tone.Synth, { 
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.5
                }
            }).toDestination();

            // Initialize the bong hit sound synth
            bongHitSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0,
                    release: 0.1
                }
            }).toDestination();
            
            // NEW: Initialize punchy kick synth for satisfaction
            kickSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 2,
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.01,
                    release: 0.05
                },
                volume: -10 
            }).toDestination();

            
        } catch (error) {
            console.error("Tone.js initialization failed:", error);
        }

        // --- DOM ELEMENTS ---
        const hitCounter = document.getElementById('hit-counter');
        const gramCounter = document.getElementById('gram-counter');
        const coinCounter = document.getElementById('coin-counter');
        const eedsCharacter = document.getElementById('eeds-character');
        const factDisplay = document.getElementById('factDisplay');
        const gameArea = document.getElementById('gameArea');
        const levelBar = document.getElementById('level-bar');
        const levelDisplay = document.getElementById('level-display');
        const xpDisplay = document.getElementById('xp-display');
        const winBar = document.getElementById('win-bar');
        const shopItemsContainer = document.getElementById('shopItemsContainer');
        const shopCoinCounter = document.getElementById('shop-coin-counter');
        const achievementsContainer = document.getElementById('achievementsContainer');
        const loadingStatus = document.getElementById('loadingStatus');
        const statHitsTaken = document.getElementById('stat-hits-taken');
        const statGoldEarned = document.getElementById('stat-gold-earned');
        const statBiggestHit = document.getElementById('stat-biggest-hit');
        const statDirtiness = document.getElementById('stat-dirtiness');
        const statWaterDirt = document.getElementById('stat-water-dirt');
        const changeWaterButton = document.getElementById('changeWaterButton');
        const statXpToNext = document.getElementById('stat-xp-to-next');
        const statRank = document.getElementById('stat-rank');
        const currentLevelStat = document.getElementById('current-level-stat');
        const cstOverlay = document.getElementById('criticalSmokeTimeOverlay');
        const cstTimerDisplay = document.getElementById('cst-timer');
        const clickInstruction = document.getElementById('click-instruction');
        const weedStash = document.getElementById('weed-stash');
        const burningEmber = document.getElementById('burning-ember');
        const dirtOverlay = document.getElementById('dirt-overlay');
        const waterDirtOverlay = document.getElementById('water-dirt-overlay');
        const bongMainTube = document.getElementById('bong-main-tube');
        const cosmicBong = document.getElementById('cosmic-bong');


        // =========================================================================
        // --- CORE GAME MECHANICS ---
        // =========================================================================

        /**
         * Calculates the total maximum possible hit amount based on upgrades and penalty.
         * @returns {number} The maximum gram amount for a single hit.
         */
        function getMaxHitAmount() {
            const gramBoostLevel = gameState.upgrades.gramBoost;
            const gramBoostAmount = gramBoostLevel * SHOP_ITEMS_CONFIG.find(i => i.id === 'gramBoost').gramBoost;
            
            // Max potential hit is BASE_MAX_HIT + all boosts
            let maxPotentialHit = BASE_MAX_HIT + gramBoostAmount;

            // Apply dirtiness penalty to the max potential hit
            const dirtPenaltyFactor = 1 - (gameState.dirtiness * DIRTINESS_PENALTY_PER_UNIT);
            const waterPenaltyFactor = 1 - (gameState.waterDirtiness * DIRTINESS_PENALTY_PER_UNIT);
            
            let finalMaxHit = maxPotentialHit * dirtPenaltyFactor * waterPenaltyFactor;

            // Ensure min hit is always achievable
            return Math.max(BASE_MIN_HIT, finalMaxHit); 
        }

        /**
         * Calculates the current smoke delay based on upgrades and CST.
         * @returns {number} The delay in milliseconds.
         */
        function getCurrentSmokeDelay() {
            const speedBoostLevel = gameState.upgrades.speedBoost;
            const speedBoostAmount = speedBoostLevel * SHOP_ITEMS_CONFIG.find(i => i.id === 'speedBoost').speedBoost;
            
            // Base delay minus boost percentage
            let delay = BASE_SMOKE_DELAY * (1 - speedBoostAmount);

            if (gameState.isCSTActive) {
                // Apply CST reduction, ensuring it doesn't go below the minimum
                delay = Math.max(CST_MIN_SMOKE_DELAY, delay - CST_SMOKE_DELAY_REDUCTION);
            }
            
            return delay;
        }

        /**
         * The main game logic function for taking a hit.
         */
        function takeBongHit() {
            if (gameState.isRefilling) {
                // Should be caught by triggerBongHit, but good safety check
                showTemporaryAlert("Need to wait for the bowl to refill! ⏳", 'text-yellow-400');
                return;
            }

            // 1. Calculate Hit Size
            const maxHit = getMaxHitAmount();
            let hitAmount = BASE_MIN_HIT + (Math.random() * (maxHit - BASE_MIN_HIT));

            let isCriticalHit = false;
            let isDoubleHit = false;

            // Check for Critical Hit (single-hit)
            if (Math.random() < CRITICAL_HIT_CHANCE) {
                hitAmount *= CRITICAL_HIT_MULTIPLIER;
                isCriticalHit = true;
                showTemporaryAlert(`CRITICAL HIT! +${(hitAmount * (CRITICAL_HIT_MULTIPLIER - 1)).toFixed(2)}g bonus!`, 'text-red-500');
                if (achievementSynth) {
                    achievementSynth.triggerAttackRelease(['A4', 'C5', 'E5'], '8n');
                }
            }

            // Apply CST multiplier
            if (gameState.isCSTActive) {
                hitAmount *= CRITICAL_SMOKE_TIME_GRAM_MULTIPLIER;
            }

            // 2. Double Hit Check (after all other multipliers)
            const doubleChanceLevel = gameState.upgrades.doubleChance;
            const doubleChanceBoost = doubleChanceLevel * SHOP_ITEMS_CONFIG.find(i => i.id === 'doubleChance').doubleChanceBoost;
            const finalDoubleChance = BASE_DOUBLE_HIT_CHANCE + doubleChanceBoost;

            if (Math.random() < finalDoubleChance) {
                hitAmount *= 2;
                isDoubleHit = true;
                showTemporaryAlert(`DOUBLE HIT! x2 Grams!`, 'text-fuchsia-400', 1000);
            }

            // 3. Update Game State
            gameState.hits++;
            gameState.gramsSmoked += hitAmount;
            gameState.hitsSinceRefill++;
            gameState.stats.hitsTaken++;

            // Update stats
            if (hitAmount > gameState.stats.biggestHit) {
                gameState.stats.biggestHit = hitAmount;
            }

            // 4. Calculate Gold
            let goldEarned = hitAmount * BASE_GOLD_PER_GRAM;
            
            // Apply Golden Bong Multiplier
            if (gameState.upgrades.golden_bong > 0) {
                goldEarned *= GOLDEN_BONG_MULTIPLIER;
            }

            // Apply CST gold multiplier
            if (gameState.isCSTActive) {
                goldEarned *= CRITICAL_SMOKE_TIME_GOLD_MULTIPLIER;
            }

            // 5. Bonus Gold Drop Check
            const coinChanceLevel = gameState.upgrades.coinChance;
            const coinChanceBoost = coinChanceLevel * SHOP_ITEMS_CONFIG.find(i => i.id === 'coinChance').coinChanceBoost;
            const finalCoinChance = BASE_BONUS_DROP_CHANCE + coinChanceBoost;

            if (Math.random() < finalCoinChance) {
                const coinAmountLevel = gameState.upgrades.coinAmount;
                const coinAmountBoost = coinAmountLevel * SHOP_ITEMS_CONFIG.find(i => i.id === 'coinAmount').coinAmountBoost;
                const bonusGold = BASE_BONUS_DROP_AMOUNT + coinAmountBoost;
                goldEarned += bonusGold;
                showTemporaryAlert(`BONUS GOLD! +${bonusGold.toFixed(0)} 💰`, 'text-yellow-400', 1000, 0.9);
            }

            goldEarned = Math.ceil(goldEarned);
            gameState.coins += goldEarned;
            gameState.stats.goldEarned += goldEarned;

            // 6. Update Dirtiness
            // Dirtiness is based on the number of hits taken regardless of hit size
            if (gameState.dirtiness < MAX_DIRTINESS) {
                gameState.dirtiness = Math.min(MAX_DIRTINESS, gameState.dirtiness + 1);
            }
            // Water dirtiness is also based on hits
            if (gameState.waterDirtiness < MAX_WATER_DIRTINESS) {
                gameState.waterDirtiness = Math.min(MAX_WATER_DIRTINESS, gameState.waterDirtiness + 1);
            }
            
            // 7. Check Level Up and Achievements
            gainXP(hitAmount);
            checkAchievements();
            
            // 8. Display Hit Feedback (NEW)
            showHitFeedback(hitAmount, goldEarned, isDoubleHit, maxHit);
            
            // 9. Apply Recoil Animation (NEW)
            eedsCharacter.classList.add('recoil-on-hit');
            // Apply a quick scale/punch to the bong
            cosmicBong.style.transition = 'transform 0.1s ease-out';
            // The bong is positioned using Tailwind classes, so we rely on the browser to figure out the base transform
            cosmicBong.style.transform = 'translate(50%, 0) scale(1.05)'; 

            setTimeout(() => {
                eedsCharacter.classList.remove('recoil-on-hit');
                // Restore bong scale to its base state (which includes the Tailwind transforms)
                // A quick way to reset the scale part of the transform:
                cosmicBong.style.transform = 'translate(50%, 0) scale(1.0)';
            }, 200);

            // 10. Update UI (called inside updateUI for single update cycle)
            updateUI();
            
            // 11. Play Sound
            playBongHitSound();

            // 12. Check for Critical Smoke Time start
            if (!gameState.isCSTActive && Math.random() < CRITICAL_SMOKE_TIME_CHANCE) {
                startCriticalSmokeTime();
            }

            // 13. Check for Refill needed
            if (gameState.hitsSinceRefill >= MAX_HITS_PER_BOWL) {
                startRefill();
            }

            // 14. Set up delay for next hit
            disableHitButton();
            // Store the timeout ID to prevent spam clicking
            bongHitTimeout = setTimeout(enableHitButton, getCurrentSmokeDelay());
        }

        /**
         * Enables the user to take a hit.
         */
        function enableHitButton() {
            eedsCharacter.classList.add('swaying');
            eedsCharacter.classList.remove('smoking');
            clickInstruction.textContent = "CLICK TO TAKE A HIT!";
            burningEmber.style.opacity = '0';
            // FIX: Clear the timeout variable so triggerBongHit allows the next click.
            bongHitTimeout = null; 
        }

        /**
         * Disables the hit button and starts hit animations.
         */
        function disableHitButton() {
            // Animation and UI changes for the hit
            eedsCharacter.classList.remove('swaying');
            eedsCharacter.classList.add('smoking');
            clickInstruction.textContent = "WAIT...";
            
            // Bong animation: "Burn" the weed stash
            weedStash.style.r = '0';
            burningEmber.style.opacity = '1';

            // Create visual effects
            createSmokePuff();
            createSmokeExhale();
            
            // Restore weed stash size after a short delay
            setTimeout(() => {
                weedStash.style.r = '8'; 
            }, 100);
        }

        /**
         * Starts the refill process.
         */
        function startRefill() {
            gameState.isRefilling = true;
            disableHitButton();
            
            eedsCharacter.classList.remove('smoking');
            eedsCharacter.classList.add('refilling');
            document.getElementById('refill-loader').classList.remove('hidden');

            const reloadSpeedLevel = gameState.upgrades.reloadSpeed;
            const reloadSpeedBoost = reloadSpeedLevel * SHOP_ITEMS_CONFIG.find(i => i.id === 'reloadSpeed').reloadSpeedBoost;
            const refillDuration = BASE_REFILL_DURATION * (1 - reloadSpeedBoost);
            
            clickInstruction.textContent = "BOWL REFILLING...";

            setTimeout(() => {
                gameState.isRefilling = false;
                gameState.hitsSinceRefill = 0;
                eedsCharacter.classList.remove('refilling');
                document.getElementById('refill-loader').classList.add('hidden');
                enableHitButton();
                playLevelUpSound(); // Use the level up sound as a successful refill chime

            }, refillDuration);
        }

        /**
         * The main click handler for the character (taking a hit).
         */
        function triggerBongHit() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }

            if (!gameState.isRefilling) {
                if (bongHitTimeout) {
                    // Ignore clicks if a hit is already in progress (waiting for delay)
                    return; 
                }
                // Only allow one hit per cycle (unless double hit)
                takeBongHit(); 
            } else {
                showTemporaryAlert("Need to wait for the bowl to refill! ⏳", 'text-yellow-400');
            }
        }
        
        /**
         * Updates the bong visual based on dirtiness.
         */
        function updateBongVisuals() {
            // Resin/Glass dirtiness (Dirtiness)
            const resinOpacity = gameState.dirtiness / MAX_DIRTINESS;
            dirtOverlay.style.opacity = resinOpacity.toFixed(2);
            
            // Water dirtiness (WaterDirtiness)
            const waterOpacity = gameState.waterDirtiness / MAX_WATER_DIRTINESS;
            waterDirtOverlay.style.opacity = waterOpacity.toFixed(2);

            // Golden Bong check
            if (gameState.upgrades.golden_bong > 0) {
                cosmicBong.classList.add('golden-bong');
            } else {
                cosmicBong.classList.remove('golden-bong');
            }
        }

        /**
         * Cleans the bong water.
         */
        function changeBongWater() {
            if (gameState.coins < WATER_CHANGE_COST) {
                showTemporaryAlert("Not enough coins to change water (100💰)", 'text-red-400');
                return;
            }
            
            gameState.coins -= WATER_CHANGE_COST;
            gameState.waterDirtiness = 0;
            gameState.stats.waterChanges++;
            
            showTemporaryAlert("Fresh water! +0.0% penalty!", 'text-blue-400', 1500);
            playCoinSound();
            updateUI();
        }

        // =========================================================================
        // --- LEVELING AND XP ---
        // =========================================================================

        /**
         * Calculates the XP needed for a given level.
         */
        function getRequiredXP(level) {
            return Math.ceil(BASE_XP * Math.pow(XP_RATE, level - 1));
        }

        /**
         * Adds XP and checks for level up.
         */
        function gainXP(hitAmount) {
            // XP is simply the gold value of the gram amount (base gold per gram)
            let xpGained = hitAmount * BASE_GOLD_PER_GRAM;
            
            // Do not apply CST/Golden Bong/etc multipliers to XP gain, keep it base
            if (gameState.isCSTActive) {
                 xpGained /= CRITICAL_SMOKE_TIME_GRAM_MULTIPLIER; // Revert CST Gram multiplier
            }
            xpGained = Math.ceil(xpGained / 2); // XP is half the base gold value
            
            gameState.xp += xpGained;

            let requiredXP = getRequiredXP(gameState.level + 1);
            
            if (gameState.xp >= requiredXP) {
                levelUp();
            }
        }

        /**
         * Processes a level up event.
         */
        function levelUp() {
            // Handle multiple level ups if enough XP was gained
            while (gameState.xp >= getRequiredXP(gameState.level + 1)) {
                gameState.xp -= getRequiredXP(gameState.level + 1);
                gameState.level++;
                showLevelUpNotification(gameState.level);
                playLevelUpSound();
            }
            // Give a reward for leveling up
            const levelUpReward = MILESTONE_REWARD * gameState.level;
            gameState.coins += levelUpReward;
            gameState.stats.goldEarned += levelUpReward;

            checkAchievements();
        }

        // =========================================================================
        // --- CRITICAL SMOKE TIME ---
        // =========================================================================

        /**
         * Starts the Critical Smoke Time event.
         */
        function startCriticalSmokeTime() {
            gameState.isCSTActive = true;
            gameArea.classList.add('critical-smoke');
            cstOverlay.classList.remove('hidden');
            
            showTemporaryAlert(`Critical Smoke Time Activated! Grams x${CRITICAL_SMOKE_TIME_GRAM_MULTIPLIER.toFixed(1)}, Gold x${CRITICAL_SMOKE_TIME_GOLD_MULTIPLIER.toFixed(1)}!`, 'text-yellow-400', CRITICAL_SMOKE_TIME_DURATION);
            
            // Set up the timer interval
            let remainingTime = CRITICAL_SMOKE_TIME_DURATION;
            cstTimerInterval = setInterval(() => {
                remainingTime -= 100;
                cstTimerDisplay.textContent = (remainingTime / 1000).toFixed(1) + "s remaining";
                if (remainingTime <= 0) {
                    clearInterval(cstTimerInterval);
                    endCriticalSmokeTime();
                }
            }, 100);

            // Set up the main timeout for event end
            cstTimeout = setTimeout(() => {
                clearInterval(cstTimerInterval);
                endCriticalSmokeTime();
            }, CRITICAL_SMOKE_TIME_DURATION);
        }

        /**
         * Ends the Critical Smoke Time event.
         */
        function endCriticalSmokeTime() {
            gameState.isCSTActive = false;
            gameArea.classList.remove('critical-smoke');
            cstOverlay.classList.add('hidden');
            clearTimeout(cstTimeout);
            clearInterval(cstTimerInterval);
            
            showTemporaryAlert("Critical Smoke Time Ended.", 'text-gray-400', 1500);
            
            // Re-enable hit button immediately, ensuring the current delay timeout is cancelled if it was CST reduced
            clearTimeout(bongHitTimeout);
            enableHitButton(); 
        }

        // =========================================================================
        // --- UI & DATA PERSISTENCE (LOCAL STORAGE) ---
        // =========================================================================

        /**
         * Renders the shop items based on the current state.
         */
        function renderShop() {
            shopItemsContainer.innerHTML = '';
            shopCoinCounter.textContent = formatNumber(gameState.coins);

            SHOP_ITEMS_CONFIG.forEach(item => {
                const currentLevel = gameState.upgrades[item.id];
                const cost = calculateCost(item.baseCost, currentLevel);
                const isMaxed = currentLevel >= item.maxPurchases;
                const canAfford = gameState.coins >= cost;
                const isDisabled = isMaxed || !canAfford;

                let cardClass = 'shop-item p-4 rounded-xl shadow-lg flex flex-col justify-between';
                if (currentLevel > 0) {
                    cardClass += ' border-l-8 border-yellow-500';
                }

                let upgradeDisplay = `Level ${currentLevel} / ${item.maxPurchases}`;
                let costDisplay = isMaxed ? 'MAXED' : `${formatNumber(cost)} 💰`;
                
                if (item.id === 'bong_master') {
                    upgradeDisplay = `Uses: ${gameState.stats.bongMasterUses}`;
                    costDisplay = `${formatNumber(BONG_MASTER_COST)} 💰`;
                }
                if (item.id === 'golden_bong') {
                    upgradeDisplay = isMaxed ? 'OWNED' : 'ONE TIME PURCHASE';
                    costDisplay = isMaxed ? 'BOUGHT' : `${formatNumber(GOLDEN_BONG_COST)} 💰`;
                }

                const itemHTML = `
                    <div class="${cardClass}">
                        <div class="flex items-center mb-3">
                            <span class="text-3xl mr-3">${item.icon}</span>
                            <h4 class="text-xl font-bold text-white">${item.name}</h4>
                        </div>
                        <p class="text-slate-400 mb-3 text-sm">${item.desc}</p>
                        <div class="flex justify-between items-center mt-auto pt-2 border-t border-slate-700/50">
                            <div class="text-sm font-semibold text-fuchsia-400">${upgradeDisplay}</div>
                            <button 
                                class="shop-buy-button !py-2 !px-4 !text-sm" 
                                data-item-id="${item.id}" 
                                ${isDisabled ? 'disabled' : ''}>
                                ${costDisplay}
                            </button>
                        </div>
                    </div>
                `;

                shopItemsContainer.innerHTML += itemHTML;
            });

            // Re-attach event listeners after innerHTML update
            document.querySelectorAll('.shop-buy-button').forEach(button => {
                button.addEventListener('click', handleShopBuy);
            });
        }

        /**
         * Renders the achievements list.
         */
        function renderAchievements() {
            achievementsContainer.innerHTML = '';

            ACHIEVEMENTS_CONFIG.forEach(item => {
                const isUnlocked = gameState.achievements[item.id];
                const cardClass = isUnlocked ? 'unlocked' : 'border-dashed border-slate-600 opacity-70';
                const icon = isUnlocked ? '🏆' : (item.isSecret && !isUnlocked ? '❓' : '🔒');
                const title = item.isSecret && !isUnlocked ? 'Secret Achievement' : item.name;
                const description = item.isSecret && !isUnlocked ? 'Unlock this for a special reward!' : item.desc;
                const reward = isUnlocked ? 'UNLOCKED' : `${formatNumber(item.reward)} 💰`;

                const itemHTML = `
                    <div class="achievement-card ${cardClass} p-4 rounded-xl shadow-lg flex items-center">
                        <span class="text-4xl mr-4 flex-shrink-0">${icon}</span>
                        <div>
                            <h4 class="text-xl font-bold text-white">${title}</h4>
                            <p class="text-slate-400 text-sm">${description}</p>
                            <p class="mt-1 text-sm font-semibold ${isUnlocked ? 'text-emerald-400' : 'text-yellow-400'}">${reward}</p>
                        </div>
                    </div>
                `;
                achievementsContainer.innerHTML += itemHTML;
            });
        }


        /**
         * The main UI update function.
         */
        function updateUI() {
            // General Counters
            hitCounter.textContent = `Hits: ${formatNumber(gameState.hits)}`;
            gramCounter.textContent = `Grams Smoked: ${gameState.gramsSmoked.toFixed(2)}g`;
            coinCounter.textContent = `Coins: ${formatNumber(gameState.coins)} 💰`;
            
            // Win Bar
            const winProgress = Math.min(100, (gameState.gramsSmoked / WIN_GRAMS) * 100);
            winBar.textContent = `Goal Progress: ${winProgress.toFixed(1)}% (${gameState.gramsSmoked.toFixed(2)}g / ${WIN_GRAMS.toFixed(1)}g)`;
            winBar.classList.toggle('hidden', winProgress < 100);
            
            // Level Bar
            const requiredXP = getRequiredXP(gameState.level + 1);
            const levelProgress = (gameState.xp / requiredXP) * 100;
            levelBar.style.width = `${levelProgress.toFixed(2)}%`;
            levelDisplay.textContent = `LEVEL ${gameState.level}`;
            xpDisplay.textContent = `${formatNumber(gameState.xp)} / ${formatNumber(requiredXP)} XP`;

            // Bong/Game Area Status
            const maxHitAmount = getMaxHitAmount();
            let clickText = `CLICK TO TAKE A HIT! (Max ${maxHitAmount.toFixed(2)}g)`;
            if (gameState.isRefilling) {
                clickText = "BOWL REFILLING...";
            } else if (bongHitTimeout) {
                clickText = "WAIT...";
            }
            clickInstruction.textContent = clickText;
            
            // Update Stats Card
            statHitsTaken.textContent = formatNumber(gameState.stats.hitsTaken);
            statGoldEarned.textContent = formatNumber(gameState.stats.goldEarned);
            statBiggestHit.textContent = `${gameState.stats.biggestHit.toFixed(2)}g`;
            statDirtiness.textContent = `${gameState.dirtiness.toFixed(0)}%`;
            statWaterDirt.textContent = `${gameState.waterDirtiness.toFixed(0)} / ${MAX_WATER_DIRTINESS}`;
            statXpToNext.textContent = formatNumber(requiredXP - gameState.xp);
            currentLevelStat.textContent = gameState.level;
            
            // Update Rank
            const currentRank = LEVEL_RANKS.slice().reverse().find(r => gameState.level >= r.level) || LEVEL_RANKS[0];
            statRank.textContent = currentRank.name;

            // Change Water Button
            const canChangeWater = gameState.coins >= WATER_CHANGE_COST;
            changeWaterButton.disabled = !canChangeWater;
            if (gameState.waterDirtiness === 0) {
                 changeWaterButton.textContent = `Water is Fresh!`;
                 changeWaterButton.disabled = true;
            } else {
                 changeWaterButton.textContent = `Change Water (${WATER_CHANGE_COST}💰)`;
            }

            // Bong Visuals
            updateBongVisuals();

            // Save state (debounced)
            saveGameStateDebounced();
            
            // Re-render sub-views if they are active
            const currentView = document.querySelector('.container > div:not(.hidden)');
            if (currentView && currentView.id === 'shopView') {
                renderShop();
            } else if (currentView && currentView.id === 'achievementsView') {
                renderAchievements();
            }
        }

        /**
         * Checks all achievements and unlocks them if conditions are met.
         */
        function checkAchievements() {
            let unlockedSomething = false;
            ACHIEVEMENTS_CONFIG.forEach(item => {
                if (!gameState.achievements[item.id] && item.check(gameState)) {
                    gameState.achievements[item.id] = true;
                    gameState.coins += item.reward;
                    gameState.stats.goldEarned += item.reward;
                    showAchievementNotification(item.name, item.reward);
                    unlockedSomething = true;
                }
            });

            // If an achievement was unlocked, re-render the achievement view if visible
            if (unlockedSomething) {
                 const currentView = document.querySelector('.container > div:not(.hidden)');
                 if (currentView && currentView.id === 'achievementsView') {
                    renderAchievements();
                }
            }
        }
        
        // =========================================================================
        // --- LOCAL STORAGE FUNCTIONS ---
        // =========================================================================

        /**
         * Save game state to Local Storage.
         */
        function saveGameStateLocal() {
            gameState.lastUpdate = Date.now(); // Update timestamp before saving
            try {
                localStorage.setItem('eedsClickerGameState', JSON.stringify(gameState));
                // console.log("Game state saved to local storage.");
            } catch (e) {
                console.error("Error saving to local storage:", e);
            }
        }

        /**
         * Load game state from Local Storage.
         */
        function loadGameStateLocal() {
            try {
                const savedState = localStorage.getItem('eedsClickerGameState');
                if (savedState) {
                    const loadedData = JSON.parse(savedState);
                    // Merge loaded state with defaults (for new properties)
                    gameState = {
                        ...gameState,
                        ...loadedData,
                        upgrades: { ...gameState.upgrades, ...loadedData.upgrades },
                        achievements: { ...gameState.achievements, ...loadedData.achievements },
                        stats: { ...gameState.stats, ...loadedData.stats }
                    };
                    // Ensure biggestHit stat is loaded as a float
                    if (typeof gameState.stats.biggestHit === 'string') {
                        gameState.stats.biggestHit = parseFloat(gameState.stats.biggestHit) || 0.0;
                    }
                    console.log("Game state loaded from local storage:", gameState);
                } else {
                    console.log("No local data found. Starting new game.");
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
            }
        }
        
        /**
         * Debounced version of saveGameState.
         */
        let saveTimeout = null;
        function saveGameStateDebounced() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(saveGameStateLocal, 1000); // Save state every second after a change
        }

        // =========================================================================
        // --- HANDLERS AND HELPERS ---
        // =========================================================================

        /**
         * Calculates the exponential cost of an upgrade.
         */
        function calculateCost(baseCost, currentLevel) {
            return Math.ceil(baseCost * Math.pow(1.5, currentLevel));
        }

        /**
         * Handles the purchase of a shop item.
         */
        function handleShopBuy(event) {
            const itemId = event.target.dataset.itemId;
            const item = SHOP_ITEMS_CONFIG.find(i => i.id === itemId);
            if (!item) return;

            const currentLevel = gameState.upgrades[itemId];
            
            // Special cases
            if (itemId === 'bong_master') {
                if (gameState.coins >= BONG_MASTER_COST) {
                    gameState.coins -= BONG_MASTER_COST;
                    gameState.stats.goldSpent += BONG_MASTER_COST;
                    
                    // Apply effect: Reset resin, reduce water dirtiness slightly
                    gameState.dirtiness = 0;
                    gameState.waterDirtiness = Math.max(0, gameState.waterDirtiness - 5);
                    gameState.stats.bongMasterUses++;

                    showTemporaryAlert("Bong Master: Resin cleared! Glass spotless!", 'text-fuchsia-400', 1500);
                    playCoinSound();
                    checkAchievements();
                } else {
                    showTemporaryAlert("Not enough coins for Bong Master!", 'text-red-400');
                }
                updateUI();
                return;
            }
            
            if (itemId === 'golden_bong' && currentLevel === 0) {
                if (gameState.coins >= GOLDEN_BONG_COST) {
                    gameState.coins -= GOLDEN_BONG_COST;
                    gameState.stats.goldSpent += GOLDEN_BONG_COST;
                    gameState.upgrades[itemId] = 1;
                    showTemporaryAlert("Golden Bong Purchased! Gold x3 FOREVER!", 'text-yellow-500', 3000);
                    playAchievementSound();
                    checkAchievements();
                } else {
                    showTemporaryAlert("Not enough coins for Golden Bong!", 'text-red-400');
                }
                updateUI();
                return;
            }
            
            // General upgrades
            const cost = calculateCost(item.baseCost, currentLevel);

            if (currentLevel < item.maxPurchases && gameState.coins >= cost) {
                gameState.coins -= cost;
                gameState.stats.goldSpent += cost;
                gameState.upgrades[itemId]++;
                showTemporaryAlert(`${item.name} upgraded to Lv.${gameState.upgrades[itemId]}!`, 'text-emerald-400');
                playCoinSound();
                checkAchievements();
                updateUI();
            } else if (currentLevel >= item.maxPurchases) {
                showTemporaryAlert(`${item.name} is already MAXED!`, 'text-red-400');
            } else {
                showTemporaryAlert("Not enough coins!", 'text-red-400');
            }
        }


        /**
         * Displays a fact in the info panel.
         */
        function handleFactButtonClick(event) {
            const factKey = event.target.dataset.fact;
            factDisplay.innerHTML = `<p class="text-slate-200">${FACTS[factKey]}</p>`;
        }
        
        /**
         * NEW: Displays a hit-specific message (grams and gold) in two separate floating texts.
         */
        function showHitFeedback(hitAmount, goldEarned, isDoubleHit, maxHit) {
            let hitMessage = `+${hitAmount.toFixed(2)}g`;
            let goldMessage = `+${goldEarned}💰`;
            
            let hitColorClass = 'text-emerald-300';
            
            // Apply color boost for special hits (1.5x max normal hit is a good proxy for "big" hit)
            if (isDoubleHit || hitAmount > maxHit * 1.5) {
                hitColorClass = 'text-fuchsia-400';
            }
            
            // Grams Message (Left/Upward) - The main feedback
            const gramsMsg = document.createElement('div');
            gramsMsg.textContent = hitMessage;
            gramsMsg.className = `hit-message ${hitColorClass}`;
            gramsMsg.style.fontSize = `2rem`;
            gramsMsg.style.left = '35%'; // Offset left
            gramsMsg.style.top = '45%';
            gameArea.appendChild(gramsMsg);
            setTimeout(() => { gramsMsg.style.animation = `fade-up-left 1.2s ease-out forwards`; }, 10);

            // Gold Message (Right/Upward) - The reward feedback
            const goldMsg = document.createElement('div');
            goldMsg.textContent = goldMessage;
            goldMsg.className = `hit-message text-yellow-400`;
            goldMsg.style.fontSize = `1.5rem`;
            goldMsg.style.left = '65%'; // Offset right
            goldMsg.style.top = '55%';
            gameArea.appendChild(goldMsg);
            setTimeout(() => { goldMsg.style.animation = `fade-up-right 1.2s ease-out forwards`; }, 10);

            // Clean up
            setTimeout(() => {
                [gramsMsg, goldMsg].forEach(msg => {
                    if (msg.parentNode) msg.parentNode.removeChild(msg);
                });
            }, 1250);
        }

        /**
         * Renamed and simplified function for general UI alerts (not hit feedback).
         */
        function showTemporaryAlert(message, colorClass, duration = 1500, scale = 1.0) {
            const tempMessage = document.createElement('div');
            tempMessage.textContent = message;
            tempMessage.className = `hit-message ${colorClass}`;
            tempMessage.style.fontSize = `${1.2 + (scale * 0.3)}rem`;
            tempMessage.style.opacity = '0'; 
            
            // Position it centrally
            tempMessage.style.left = '50%';
            tempMessage.style.top = '50%';
            tempMessage.style.transform = 'translate(-50%, -50%)';

            gameArea.appendChild(tempMessage);

            // Use the default fade-up-left animation for simplicity on alerts
            setTimeout(() => {
                tempMessage.style.animation = `fade-up-left ${duration / 1000}s ease-out forwards`;
            }, 10); 

            setTimeout(() => {
                if (tempMessage.parentNode) {
                    tempMessage.parentNode.removeChild(tempMessage);
                }
            }, duration + 50);
        }


        /**
         * Displays the achievement notification.
         */
        function showAchievementNotification(name, reward) {
            const notification = document.getElementById('achievement-notification');
            document.getElementById('achievement-name').textContent = name;
            document.getElementById('achievement-reward').textContent = `+${formatNumber(reward)} 💰 Reward`;
            
            notification.classList.remove('hidden');
            
            // Play sound
            if (achievementSynth) {
                achievementSynth.triggerAttackRelease(['C6', 'G5', 'C6'], '8n');
            }

            // Show animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); 

            // Hide animation
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);

            // Full hide
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4500);
        }

        /**
         * Displays the level up notification.
         */
        function showLevelUpNotification(level) {
            const notification = document.getElementById('level-up-notification');
            const currentRank = LEVEL_RANKS.slice().reverse().find(r => level >= r.level) || LEVEL_RANKS[0];
            
            document.getElementById('level-up-name').textContent = `LEVEL ${level} - ${currentRank.name}`;
            
            notification.classList.remove('hidden');

            // Show animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10); 

            // Hide animation
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);

            // Full hide
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4500);
        }


        // --- VISUAL EFFECTS ---

        /**
         * Creates a small smoke puff animation inside the bong.
         */
        function createSmokePuff() {
            const puff = document.createElement('div');
            puff.className = 'smoke-puff';
            gameArea.appendChild(puff);
            setTimeout(() => {
                gameArea.removeChild(puff);
            }, 1000); 
        }

        /**
         * Creates an exhale smoke animation.
         */
        function createSmokeExhale() {
            const exhale = document.createElement('div');
            exhale.className = 'smoke-exhale';
            gameArea.appendChild(exhale);
            setTimeout(() => {
                gameArea.removeChild(exhale);
            }, 1500);
        }


        // --- AUDIO FUNCTIONS ---

        /**
         * Plays the bong hit sound effect (UPDATED with a punchy kick).
         */
        function playBongHitSound() {
            if (bongHitSynth && kickSynth) {
                // The intensity of the noise sound can be related to the dirtiness of the bong
                const filterFrequency = 10000 - (gameState.dirtiness * 50) - (gameState.waterDirtiness * 30);
                const noiseDuration = 0.2; 
                
                // Add a crackle to the sound based on dirtiness (lowers the filter for a 'muddier' sound)
                bongHitSynth.set({
                    filter: {
                        frequency: Math.max(500, filterFrequency)
                    }
                });
                
                // Play a simple, quick noise burst
                bongHitSynth.triggerAttackRelease(noiseDuration);

                // ADDED: Punchy low-frequency click for extra oomph
                kickSynth.triggerAttackRelease("C1", "8n"); 

                // Add a small bubbling sound for the water effect
                if (Tone.Transport.state !== 'started') {
                    Tone.Transport.start();
                }
                
                const bubble = new Tone.NoiseSynth({
                    noise: { type: 'brown' },
                    envelope: {
                        attack: 0.01,
                        decay: 0.1,
                        sustain: 0,
                        release: 0.05
                    },
                    volume: -20
                }).toDestination();
                bubble.triggerAttackRelease(0.1, Tone.now() + 0.05);
                setTimeout(() => bubble.dispose(), 500);
            }
        }

        /**
         * Plays the coin/purchase sound effect.
         */
        function playCoinSound() {
             if (coinSynth) {
                coinSynth.triggerAttackRelease(['C5', 'E5', 'G5'], '16n', Tone.now());
            }
        }
        
        /**
         * Plays the level up sound effect.
         */
        function playLevelUpSound() {
             if (levelUpToneSynth) {
                levelUpToneSynth.triggerAttackRelease(['C4', 'G4', 'C5'], '4n', Tone.now(), 0.5);
            }
        }
        
        /**
         * Plays the achievement sound effect (distinct from the main one).
         */
        function playAchievementSound() {
             if (achievementSynth) {
                achievementSynth.triggerAttackRelease(['C6', 'G6', 'C7'], '8n', Tone.now());
            }
        }


        // --- UTILITY FUNCTIONS ---

        /**
         * Formats a number with commas for display.
         */
        function formatNumber(num) {
            return Math.floor(num).toLocaleString();
        }

        /**
         * Shows the specified view and hides all others.
         */
        function showView(viewId) {
            document.getElementById('infoView').classList.add('hidden');
            document.getElementById('testView').classList.add('hidden');
            document.getElementById('minigameView').classList.add('hidden');
            document.getElementById('shopView').classList.add('hidden');
            document.getElementById('achievementsView').classList.add('hidden');
            
            document.getElementById(viewId).classList.remove('hidden');

            // Re-render only when switching to Shop/Achievements
            if (viewId === 'shopView') {
                renderShop();
            } else if (viewId === 'achievementsView') {
                renderAchievements();
            } else if (viewId === 'minigameView') {
                // Ensure hit button is active when returning to the game
                if (!gameState.isRefilling && !bongHitTimeout) {
                    enableHitButton();
                }
            }
        }
        
        /**
         * Initializes the game for offline use by loading from local storage.
         */
        function initializeOfflineGame() {
            loadingStatus.textContent = "Loading offline game from local storage...";
            loadingStatus.classList.remove('hidden');

            loadGameStateLocal();

            // After loading, proceed to the game
            loadingStatus.textContent = "Welcome to EEDSCLICKER! Playing in OFFLINE mode.";
            
            // Slight delay for message visibility
            setTimeout(() => {
                loadingStatus.classList.add('hidden');
                // Check if the user has hits to determine if they've played before
                if (gameState.hits > 0) {
                     showView('minigameView');
                } else {
                     // Show info view for first-time players
                     showView('infoView');
                }
                updateUI();
            }, 1500);
        }


        // =========================================================================
        // --- INITIALIZATION ---
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // Initialize the game for offline play
            initializeOfflineGame();
            
            // Start character animation immediately on load
            if (eedsCharacter) {
                eedsCharacter.classList.add('swaying');
            }

            // Event listener for "Begin Test" button to switch to the minigame view
            document.getElementById('beginTestButton').addEventListener('click', () => {
                showView('minigameView');
            });

            // Add event listeners for navigation buttons
            document.getElementById('navInfoButton').addEventListener('click', () => showView('infoView'));
            document.getElementById('navMinigameButton').addEventListener('click', () => showView('minigameView'));
            document.getElementById('navShopButton').addEventListener('click', () => showView('shopView'));
            document.getElementById('navAchievementsButton').addEventListener('click', () => showView('achievementsView')); 
            
            // Add event listeners for fact buttons
            document.querySelectorAll('.fact-button[data-fact]').forEach(button => {
                button.addEventListener('click', handleFactButtonClick);
            });


            // Re-attach click listener for eedsCharacter 
            if (eedsCharacter) {
                eedsCharacter.addEventListener('click', triggerBongHit);
            }

            // Add listener for the change water button
            if (changeWaterButton) {
                changeWaterButton.addEventListener('click', changeBongWater);
            }
        });
    </script>
</body>
</html>
